👈 [[3 运输层]]

不同于 *运输层* 和 *应用层*，网络中的每台主机、每台路由器都运行着 *网络层*。

## 概述

### 转发和路由选择

**转发**(forwarding)：路由器将收到的分组移动到适当输出链路的过程。

**路由选择**(routing)：网络中的所有路由器经 *路由选择协议* 协同决定分组从源到目的地结点的具体路径。

*转发* 是一个路由器的动作，*路由选择* 是全网络范围的动作。

**转发表**：每台路由器持有，它检查到达分组首部字段的值并查询 *转发表* 进行 *转发*。

*转发* 的决定：

- 链路层交换机基于 *链路层* 字段的值
- 路由器基于 *网络层* 字段的值

### 网络服务模型

**网络服务模型** 定义了分组在发送与接收端系统之间的端到端运输特性。

因特网的网络层提供 *尽力而为服务*；ATM 网络提供 **恒定比特率(CBR) ATM 网络服务** 和 **可用比特率(ABR) ATM 网络服务**。

## 虚电路和数据报网络

*网络层* 也能提供面向连接服务和无连接服务，但与 *运输层* 有所不同：

- 在 *网络层* 中，这些服务是由网络层向运输层提供的 *主机到主机* 的服务；而在 *运输层* 中，这些服务是由运输层向应用层提供的 *进程到进程* 的服务。
- 每种网络体系结构只提供面向连接服务 ==或== 无连接服务，分别称为 **虚电路(VC)网络**、**数据报(datagram)网络**。

### 虚电路网络

除因特网外的很多其他网络体系结构都是 *虚电路网络*，它们在网络层的连接称为 *虚电路*。

*虚电路* 的 3 个阶段：*虚电路* 建立 -> 数据传送 -> *虚电路* 拆除。

一条 *虚电路* 的组成：

- 源和目的主机之间的一系列 *链路和路由器*
- 每段链路的 *VC 号*
- 每台路由器的 *转发表* 表项

通过虚电路传输的分组在其首部携带一个 *VC 号*，每到达一个路由器，后者就从转发表中获取一个新的 VC 号并赋给分组。这样做的理由：

- 减少分组首部中 VC 字段的长度
- 简化虚电路的建立

*虚电路网络* 中的路由器需要为每条连接维持 **连接状态信息**，每跨越某台路由器建立一个新连接，它的 *转发表* 中就增加一项，该连接拆除时，该项随之删除。

对比 *虚电路* 与 *运输层的连接*：

- *运输层的连接* 建立时，两个端系统决定参数并知情，中间路由器均不知情。
- *虚电路* 建立时，需要所有中间路由器的参与，它们都知情。

**信令报文**：有端系统向网络发送指示虚电路建立与拆除的报文，以及路由器之间传递的用于建立与拆除虚电路的报文。

**信令协议**：交换 *信令报文* 的协议。

### 数据报网络

在 *数据报网络* 中，每当端系统要发送分组，它只需为其加上首部控制信息，然后将其推进网络，每台中间路由器查询其转发表以转发分组。

假设一台路由器有 4 个出链路，其转发表如下：

![[Snipaste_240423_190749.png|400]]

有一个到达分组的目的地址为 `11001000 00010111 00011000 10101010`，它将由 **最长前缀匹配规则** 被匹配到输出链路 $1$。

对比 *数据报网络* 和 *虚电路网络* 的转发表更新：

- *虚电路网络* 在有经过路由器的连接建立或拆除时更新
- *数据报网络* 每 $1$ ~ $5$ 分钟运行一次路由选择算法更新

### 虚电路和数据报网络的由来

*虚电路网络* 比 *数据报网络* 复杂。

*因特网* 作为一种数据报网络，很多额外功能（可靠数据传输、拥塞控制、DNS）在端系统的更高层实现，因而其实现简单、易于扩展。

## 路由器工作原理

路由器体系结构：

![[Snipaste_240423_191530.png|600]]

**路由选择处理器** 执行 *路由选择协议*，维护 *路由选择表* 和连接的状态信息，计算 *转发表*，并执行网络管理功能。

**输入端口**、**输出端口** 和 **交换结构** 共同实现了转发功能，总称其为 **路由器转发平面**，其为 *硬件实现*（因为远快于软件实现）。

称路由器的控制功能为 **路由器控制平面**，其为 *软件实现*。

### 输入端口

路由器使用 *转发表* 查询输出端口，而 *输入端口* 存有表的一个副本。

![[Snipaste_240423_192130.png|500]]

查询需用极快的硬件进行，通常使用 **三态内容可寻址存储器**(TCAM)。

### 交换结构

交换的完成方式：

- 经内存：同一时间只能执行一个内存读写（即转发一个分组）。
- 经总线：同一时间只允许一个分组通过总线。
- 经互联网络：可以并行转发多个分组。

![[Snipaste_240427_150331.png|600]]

### 输出端口

![[Snipaste_240427_150728.png|500]]

### 何处出现排队

发生处理缓慢的部位——

- 交换结构 => 入口排队
- 输出端口 => 出口排队

**线路前部(HOL)阻塞**：在一个输入队列中排队的分组被位于线路前部的另一个分组所阻塞，而不得不等待通过交换结构，即使输出端口是空闲的。

![[Snipaste_240427_151004.png|500]]

### 路由选择控制平面

## 网际协议：因特网中的转发和编址