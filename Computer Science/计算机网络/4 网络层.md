👈 [[3 运输层]]

不同于 *运输层* 和 *应用层*，网络中的每台主机、每台路由器都运行着 *网络层*。

## 概述

![[网络层.png|350]]

### 转发和路由选择

**转发**：路由器将收到的分组移动到适当输出链路的过程。

**路由选择**：网络中的所有路由器经 *路由选择协议* 协同决定分组从源到目的地结点的具体路径。

*转发* 是单个路由器的动作，*路由选择* 是全网络范围的动作。

**转发表**：每台路由器持有，它检查到达分组首部字段的值并查询 *转发表* 进行 *转发*。

*转发* 的决定：

- 链路层交换机基于 *链路层* 字段的值
- 路由器基于 *网络层* 字段的值

### 网络服务模型

**网络服务模型** 定义了分组在发送与接收端系统之间的端到端运输特性。

因特网的网络层提供 *尽力而为服务*；ATM 网络提供 **恒定比特率(CBR) ATM 网络服务** 和 **可用比特率(ABR) ATM 网络服务**。

## 虚电路和数据报网络

*网络层* 也能提供面向连接服务和无连接服务，但与 *运输层* 有所不同：

- 在网络层中，这些服务是由网络层向运输层提供的 *主机到主机* 的服务；而在运输层中，这些服务是由运输层向应用层提供的 *进程到进程* 的服务。
- 每种网络体系结构只提供 *面向连接服务* ==或== *无连接服务*，分别称为 **虚电路(VC)网络**、**数据报(datagram)网络**。

### 虚电路网络

除因特网外的很多其他网络体系结构都是 *虚电路网络*，称它们在网络层的连接为 *虚电路*。

*虚电路* 的 3 个阶段：虚电路建立 -> 数据传送 -> 虚电路拆除。

一条 *虚电路* 的构成：

- 源和目的主机之间的一系列 *路由器和链路*
- 每段链路的 *VC 号*
- 每台路由器的 *转发表* 表项

通过虚电路传输的分组在其首部携带一个 *VC 号*，每到达一个路由器，后者就从转发表中获取一个新的 VC 号赋予分组。这样做的理由：

- 减少分组首部中 VC 字段的长度
- 简化虚电路的建立

*虚电路网络* 中的路由器需要为每条连接维持 **连接状态信息**，每跨越某台路由器建立一个新连接，它的 *转发表* 中就增加一项，该连接拆除时，该项随之删除。

对比 *虚电路* 与 *运输层的连接*：

- *运输层的连接* 建立时，两个端系统决定参数且知情，中间路由器均不知情。
- *虚电路* 建立时，需要所有中间路由器的参与，它们都知情。

**信令报文**：端系统向网络发送的、指示虚电路建立与拆除的报文，以及路由器之间传递的、用于建立与拆除虚电路的报文。

**信令协议**：交换 *信令报文* 的协议。

### 数据报网络

在 *数据报网络* 中，端系统要发送分组时，需为其加上首部控制信息，然后将其推进网络，每台中间路由器查询其转发表以转发分组。

假设一台路由器有 4 个出链路，其转发表如下：

![[Snipaste_240423_190749.png|400]]

有一个到达分组的目的地址为 `11001000 00010111 00011000 10101010`，它的前缀与输出链路 `1`、`2` 都匹配，但将由 **最长前缀匹配规则** 被匹配到 `1`。

对比 *数据报网络* 和 *虚电路网络* 的转发表更新：

- *虚电路网络* 在有经过路由器的连接建立或拆除时更新
- *数据报网络* 每 $1$ ~ $5$ 分钟运行一次路由选择算法更新

### 虚电路和数据报网络的由来

*虚电路网络* 比 *数据报网络* 复杂。

*因特网* 作为一种数据报网络，很多额外功能（可靠数据传输、拥塞控制、DNS）在端系统的更高层实现，因而其实现简单、易于扩展。

## 路由器工作原理

路由器体系结构：

![[Snipaste_240423_191530.png|600]]

**路由选择处理器** 执行 *路由选择协议*，维护 *路由选择表* 和连接的状态信息，计算 *转发表*，并执行网络管理功能。

**输入端口**、**输出端口** 和 **交换结构** 共同实现了转发功能，总称其为 **路由器转发平面**，其为 *硬件实现*（因为远快于软件实现）。

称路由器的控制功能为 **路由器控制平面**，其为 *软件实现*。

### 输入端口

路由器使用 *转发表* 查询输出端口，而 *输入端口* 存有该表的一个副本。

![[Snipaste_240423_192130.png|400]]

查询需用极快的硬件进行，通常使用 **三态内容可寻址存储器**(TCAM)。

### 交换结构

交换的完成方式：

- 经内存：同一时间只能执行一个内存读写（即转发一个分组）。
	- 记内存带宽为读写 $B$ 分组/秒，则总的转发吞吐量 $\leqslant$ $\large \frac{B}{2}$ 分组/秒。
- 经总线：同一时间只允许一个分组通过总线。
- 经互联网络：可以并行转发多个分组。

![[Snipaste_240427_150331.png|500]]

### 输出端口

![[Snipaste_240427_150728.png|500]]

### 何处出现排队

发生处理缓慢的部位——

- 交换结构 => 输入端口排队
- 输出端口 => 输出端口排队

**线路前部(HOL)阻塞**：在一个输入队列中排队的分组被位于线路前部的另一个分组所阻塞，而不得不等待通过交换结构，即使它的目标输出端口是空闲的。

下图中，3 个深蓝色的数据报竞争上方输出端口，浅蓝色的数据报的目标为中间输出端口，但它被其前方的深蓝色所阻塞（因为竞争失败）：

![[Snipaste_240427_151004.png|400]]

## 网际协议：因特网中的转发和编址

### 数据报格式

IPv4 首部有 $20$ 个字节（假设没有 `option` 字段）。

![[Snipaste_240429_132821.png|450]]

#### IP 数据报分片

![[MSS 与 MTU.png|450]]

数据报所经路径上每段链路的 *MTU* 可能不同，因此传输时将其分为若干片，由接收方端系统负责重新组装。

> message -> package -> datagram -> fragment -> frame

![[Snipaste_240429_133230.png|500]]

- 发送主机将每个数据报的 **标识号** 递增 `1`（同一数据报的不同分片，其 *标识号* 与原数据报相同）
- 设有 `n` 个分片，则前 `n - 1` 个的 **标志比特** 均为 `1`，最后一个的为 `0`，表示本数据报的结束；且前 `n - 1` 个均为定长，最后一个补足余量
- 用 **偏移字段** 标识每个片所在原数据报中的位置，它必须为 `8` 的倍数（偏移值 $\times$ `8` $=$ 字节数）

发送一个总长 `4000` 字节的数据报：

![[Snipaste_240429_133320.png|600]]

数据报的 **有效载荷** 仅在所有分片重组成功时向上交给运输层，如果接收到的分片不完整，将直接丢弃。

*IPv6* 废除了分片机制。

### IPv4 编址

**接口**：主机与物理链路之间的边界。

一个 IP 地址与一个 *接口* 相关联，而不是一台路由器或主机。

**子网**：下图中的 3 个灰色阴影部分。

![[Snipaste_240429_134303.png|400]]

上图中最左侧的 *子网* 有着 IP 地址 `223.1.1.0/24`，其中的 `24` 为 **子网掩码**，意为 $32$ 比特中的左侧 $24$ 比特定义了 *子网* 地址。

*子网掩码* 形式上必须为 `1..10..0`，称前面为 `1` 的位为 *网络位*，称后面为 `0` 的位为 *主机位*。

下图中则有 6 个 *子网*：包括 3 个路由器两两之间的网络。

![[Snipaste_240429_134545.png|350]]

因特网的地址分配策略称为 **无类别域间路由选择**(CIDR)。

`255.255.255.255` 为 **IP 广播地址**，以之为目的地址的数据报将传输给所在网络中的所有主机。

> [!tip] 计算某子网的网络地址、广播地址、主机地址范围、主机数量
> 
> 已知任一接口的 IP 地址 `ip` 和子网掩码 `mask`：
> 
> - `网络地址 = ip & mask`
> - `广播地址 = network_addr | (!mask)`（`网络地址` 的 *主机位* 全变为 `1`）
> - 主机地址范围为 `(网络地址 + 1)..=(广播地址 - 1)`
> - 主机数量为 `pow(2, 主机位数) - 2`

> [!question] 主机和子网最初如何取得自身的地址？

1. 获取一块地址

IP 地址由 **因特网名字和编号分配机构**(ICANN) 管理，它向各 *ISP* 分配一些地址，后者再分发给下级组织。

![[Snipaste_240429_204638.png|600]]

2. 获取主机地址：动态主机配置协议

组织为其中的主机和路由器接口逐个分配地址，由 **动态主机配置协议**(DHCP) 自动完成，它是一种 *即插即用协议*。

每个 *子网* 有若干 *DHCP* 服务器。

新到达子网的主机获取其 IP 地址的步骤：DHCP 发现 -> ~ 提供 -> ~ 请求 -> ~ 确认。

这 4 个报文的 `ip_dest` 均为 *IP 广播地址*。

![[Snipaste_240429_205147.png|400]]

*DHCP* 的不足：子网中一个地理上移动的结点将不断得到新的 IP 地址，无法维持与远程应用间的 TCP 连接。

3. 网络地址转换

**网络地址转换**(NAT) 隐藏内部主机的地址，而对外界暴露一个特殊的地址，其地址空间取 `10/8` / `172.16/12` / `192.168/16` 之一。

NAT 路由器对外界的行为如同一个具有单一 IP 地址的单一设备，它使用一张 **NAT 转换表** 决定将收到的分组转发给内部的哪一台主机（表项为 `{端口号, IP/端口号}`）。

*NAT* 妨碍 *P2P* 程序。

4. UPnP

**通用即插即用**(UPnP) 允许外部主机使用 TCP 或 UDP 向 *NAT 化* 的主机发起通信会话。

### 因特网控制报文协议

**因特网控制报文协议**(ICMP) 使得主机和路由器能够沟通网络层信息，例如差错报告。

### IPv6

#### IPv6 数据报格式

![[Snipaste_240508_093031.png|500]]

- 地址长度由 $32$ 比特增加到 $128$ 比特
- 简化高效的 $40$ 字节首部

#### 从 IPv4 到 IPv6 的迁移

**双栈**(dual-stack) 和 **建隧道**。

## 路由选择算法

*路由选择* 的目标：确定从发送方到接收方通过路由器网络的好路径。

主机通常直接与一台路由器连接，称其为主机的 **默认路由器** / **第一跳路由器**。

称源主机的 *默认路由器* 为 **源路由器**，称目的主机的为 **目的路由器**。

路由选择算法的分类：

| 分类方法  | 类别                                               |
| ----- | ------------------------------------------------ |
| 实现方式  | 全局式：又称 **链路状态**(LS) 算法<br>分散式：例如 **距离向量**(DV) 算法 |
| 变化情况  | 静态：路由随时间变化缓慢<br>动态：当网络负载变化时改变路由选择路径              |
| 负载敏感性 | 负载敏感：链路费用动态变化，以反映拥塞程度<br>负载迟钝：链路费用不明显反映拥塞程度      |

### 链路状态路由选择算法

*LS 算法* 的常见实现为 *Dijkstra 算法*。

![[Snipaste_240512_091925.png|400]]

![[Snipaste_240512_092002.png|600]]

**路由震荡**：线路费用变化太快，路由选择频繁改变，数据包的路线频繁变动，有时甚至走回头路，导致数据传输变慢甚至丢失。

避免 *路由震荡* 的方法：确保所有路由器不同时运行 *LS 算法*，随机化路由器发送链路通告的时间。

👉 [[5 链路层：链路、接入网和局域网]]