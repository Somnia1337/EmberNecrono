![[OSI 5层模型.png|300]]

## 什么是因特网

端系统通过 **通信链路** 和 **分组交换机** 连接。

**分组**(packet)：端系统间传输数据时，将数据分段、每段加上首部字节形成的信息包。

**分组交换机**(packet switch)：传递网络包，包括 **路由器**(router) 和 **链路层交换机**(link-layer switch)。

端系统通过 **因特网服务提供商**(ISP) 接入因特网，每个 ISP 是由多个分组交换机和多段通信链路组成的网络。

**协议**(protocol)：协议定义了多个通信实体之间交换报文的格式和次序，以及收发报文或其他事件所采取的动作，控制着因特网中信息的收发。

**TCP**(Transmission Control Protocol，传输控制协议) 和 **IP**(Internet Protocol，网际协议) 是最重要的协议。

用人类的交流过程类比协议的工作方式：

![[Snipaste_240307_152358.png|500]]

> [!summary] 因特网的描述
> 
> - 构成
> 	- 硬件：端系统，通信链路，分组交换机
> 	- 软件：网络应用程序，协议
> 	- 是网络的网络
> - 服务：为分布式应用程序提供了运行条件

## 网络边缘

**端系统**：端系统上运行应用程序，也称为 **主机**。

主机分为 **客户** 和 **服务器**。

## 网络核心

通过网络链路和交换机传输数据的两种基本方法：**分组交换**(packet switching)，**电路交换**(circuit switching)。

### 分组交换

#### 存储转发传输

分组以链路的最大传输速率通过通信链路传输，例如：分组的大小为 $L$ bit，链路的传输速率为 $R$ bps，则传输该分组用时 $\large \frac{L}{R}$ s。

**存储转发传输**：在交换机向输出链路传输某个分组前，必须接收到整个分组。大多数分组交换机都采用此机制。

存储转发传输影响着传输的时延。考虑以下传输路径：

```text
源 --> 路由器 --> 目的地
```

沿用上文的符号 $L$ 和 $R$，忽略传播时延（比特流以近光速通过线路的耗时）：

- 时刻 $0$：源开始传输，路由器立即接收到首个比特，但由于存储转发机制而不能开始向目的地传输。
- 时刻 $\large \frac{L}{R}$：路由器接收到整个分组，开始向目的地传输。
- 时刻 $\large \frac{2 L}{R}$：目的地接收到整个分组。

最终用时 $\large \frac{2 L}{R}$。

假如路由器每接收到一个比特就立即转发到目的地，最终用时将为 $\large \frac{L}{R}$。

通过由 $N$ 条速率为 $R$ 的链路组成的路径，从源向目的地发送 $1$ 个分组的端到端时延：$$d = N \frac{L}{R}$$

发送 $P$ 个分组的端到端时延：$$d = (N + P - 1) \frac{L}{R}$$

#### 排队时延和分组丢失

每个分组交换机连接着多条链路，其对每条链路都保有一个 **输出缓存**/**输出队列**，用于存储路由器准备发往该链路下个结点的分组。

如果某个分组已经到达，但目标出链路正忙于传输其他分组，这个已经到达的分组只能在输出缓存中等待，称这个时延为 **排队时延**。

缓存的大小有限，如果缓存已经充满，接下来到达缓存的分组将被丢弃，称为 **分组丢失**/**丢包**。

#### 转发表和路由选择协议

每个端系统都有一个 *IP 地址*，源向目的地发送的分组头部包含了目的地的 IP 地址。

每台路由器都有一个 **转发表**，将目的地址映射为出链路。分组到达时，路由器检查目的地 IP 地址并搜索其转发表，从而将分组输出到正确的出链路。

因特网的 **路由选择协议** 用于自动设置转发表。

### 电路交换

不同于 *分组交换* 对资源的按需分配，*电路交换* 会预留端系统之间通信所需的资源（缓存，传输速率等）。

用餐厅类比两种交换方式：

- *分组交换* 是不接受预定的餐厅，顾客到店后可能立即就餐，也可能等待。
- *电路交换* 是只接受预定的餐厅，顾客必须预定，也保证到店后立即就餐。

在电路交换中，设某条链路能容纳 $N$ 条电路，则每个连接将占用其中的 $1$ 条，也即占用链路带宽资源的 $\large \frac{1}{N}$；如果链路的总传输速率为 $R$，则每个连接获得 $\large \frac{R}{N}$ 的专用速率。

#### 电路交换中的复用

链路中的电路通过 **频分复用**(FDM) 和 **时分复用**(TDM) 实现。

设 $N$ 为电路总数，$B$ 为链路带宽，$T$ 为帧速率（$1$ 帧 $=$ $N$ $\times$ 时隙），$M$ 为一个时隙中的比特数：

- FDM：每条电路得到连续的部分带宽，速率为 $\large \frac{B}{N}$。
- TDM：每条电路周期性地在短时间间隔（时隙）内得到全部带宽，速率为 $T \times M$。

![[Snipaste_240312_080903.png|500]]

#### 分组交换与电路交换的对比

*分组交换* 的性能优于 *电路交换*：

- 电路交换不考虑需求，而预先分配资源，浪费了已分配而未使用的链路时间。
- 电路交换需要为每个连接预留电路，能够支持的并发量较小。

### 网络的网络

因特网是一个网络的网络：

- 由十多个第一层 ISP 和数十万个较低层 ISP 组成。
- 较低层 ISP 与较高层 ISP 相连，后者彼此相连。
- 用户和内容提供商是较低层 ISP 的客户，后者是较高层 ISP 的客户。

## 分组交换网中的时延、丢包和吞吐量

### 分组交换网中的时延概述

分组从一个结点沿某条路径到达后继结点的过程中，主要的时延有：

| 时延       | 英文 (~delay)      | 原因                         | 数量级   |
| -------- | ---------------- | -------------------------- | ----- |
| **结点处理** | nodal processing | 检查分组首部<br>检查比特级差错<br>选择出链路 | μs    |
| **排队**   | queuing          | 先于分组到达且正在排队的分组             | μs/ms |
| **传输**   | transmission     | 将分组的所有比特传输到出链路             | μs/ms |
| **传播**   | propagation      | 比特经由出链路到达下个结点              | ms    |

![[Snipaste_240307_152531.png|400]]

称这些时延的和为 **结点总时延**。

*传输时延* 和 *传播时延* 的比较：

- *传输时延*：结点将分组的所有比特输送到出链路的耗时，为 $\large \frac{L}{R}$（含义见前文）
- *传播时延*：一个比特从当前结点到达下个结点的耗时，为 $\large \frac{d}{s}$（两结点间距除以传播速率），$s$ 近似光速（约 $[2, 3] \times 10^8$ m/s）
- 两者的决定变量互相独立，即：
	- *传输时延* 与 $d$ 或 $s$ 均无关
	- *传播时延* 与 $L$ 或 $R$ 均无关

### 排队时延和丢包

#### 排队时延

不同分组的排队时延可能不同：如果 10 个分组同时到达空队列，第 1 个分组没有排队时延，而第 10 个分组的排队时延最长。

设 $a$ 为分组到达队列的平均速率（分组/秒），沿用 $L$、$R$，则比特到达队列的平均速率为 $a L$ bps，称比率 $\large \frac{a L}{R}$ 为 **流量强度**。当 ${\large \frac{a L}{R}} > 1$，即比特到达队列的平均速率超过从队列传输出去的平均速率，则队列趋向无限增长，排队时延趋向 $\infty$。

原则：设计系统时，流量强度不能大于 $1$。

假设分组的到达是随机的，且队列容量无限，平均排队时延与流量强度的关系为：

![[Snipaste_240307_152610.png|500]]

#### 丢包

现实中，队列的容量有限，随着流量强度接近 $1$，路由器将 **丢弃** 无法容纳的分组，造成分组丢失。

### 端到端时延

上文的时延是针对一个结点而言，现在考虑从源到目的地的总时延。设二者之间有 $N$ 条链路，且网络无拥塞（排队时延为 $0$），则端到端时延：$$d_{end-end} = N (d_{proc} + d_{trans} + d_{prop})$$

#### Traceroute

![[Snipaste_240306_101618.png|400]]

#### 端系统、应用程序和其他时延

- 要向共享媒体传输分组的端系统可以有意延迟其传输，以与其他端系统共享媒体。
- 经 IP 语音(VoIP) 应用中的媒体分组化时延。

### 计算机网络中的吞吐量

考虑从主机 A 到主机 B 传输一个大文件：

- 在任意时刻，称主机 B 接收到该文件的速率（以 bps 计）为 **瞬时吞吐量**。
- 设 $F$ 为文件的总比特数，$T$ 为主机 B 接收整个文件的用时（以 s 计），称比率 $\large \frac{F}{T}$ 为 **平均吞吐量**。

某网络的吞吐量取决于其 **瓶颈链路** 的传输速率，即 ${\rm{min}}\{R_1, R_2, \cdots, R_n\}$。

## 协议层次及其服务模型

### 分层的体系结构

分层的优点：对于大而复杂且需要不断更新的系统，改变某个服务的实现不会影响其他组件的功能。

#### 协议分层

| 五层因特网协议栈 | 功能               |
| :------: | ---------------- |
|   应用层    | 网络应用程序及其应用层协议    |
|   运输层    | 在应用程序端点之间传送应用层报文 |
|   网络层    | 在主机之间传输分组        |
|   链路层    | 在结点之间传输分组        |
|   物理层    | 在结点之间传输比特        |

“分组”在各层中的名称：

- 应用层：**报文** | **message**
- 运输层：**报文段** | **segment**
- 网络层：**数据报** | **datagram**
- 链路层：**帧** | **frame**

#### OSI 模型

| 七层 ISO OSI 参考模型 |
| :-------------: |
|       应用层       |
|       表示层       |
|       会话层       |
|       运输层       |
|       网络层       |
|       链路层       |
|       物理层       |

### 封装

分组在各层之间传输的过程中，每层都在分组头部添加本层的附加信息，称为 **封装**。

![[Snipaste_240308_105256.png|600]]

👉 [[2 应用层]]