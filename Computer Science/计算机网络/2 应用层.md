👈 [[1 计算机网络和因特网]]

## 应用层协议原理

### 网络应用程序体系结构

**应用程序体系结构**(application architecture) 由开发者设计，规定了如何在各种端系统上组织该应用程序。

2 种主流的体系结构：客户 - 服务器体系结构(CS)，对等体系结构(P2P)。

![[Snipaste_240312_092845.png|500]]

在 **客户 - 服务器体系结构**(client-server architecture) 中，有一个总是打开的主机（服务器），它服务于来自许多其他主机（客户）的请求。

较大型的网络站点配备大量的主机构成数据中心，用作大型的虚拟服务器。

在 **对等体系结构**(P2P architecture) 中，应用程序在间断连接的主机对之间直接通信，称这些主机对为对等方，它们对位于数据中心的服务器有最小的依赖。

很多流量密集型应用程序采用对等体系结构，如文件共享（BitTorrent），对等方协助下载加速器（迅雷）等。

### 进程通信

进行网络通信的是进程而非程序，一个进程可以视为运行在一个端系统上的程序。

两个端系统上的进程通过网络交换 **报文**(message) 进行通信，发送进程生成并向网络中发送报文，接收进程接收该报文并可能发回一个报文作为响应。

#### 客户和服务器进程

在给定的一对进程之间的通信场景中，发起通信的进程视为客户，在会话开始时等待联系的进程视为服务器。

#### 进程与计算机网络之间的接口

进程通过称为 **套接字**(socket) 的软件接口与网络交换报文。

用房子和门类比进程和套接字：进程相当于房子，套接字相当于门，发送进程发送报文相当于将报文从门推出去，报文在接收进程处也通过门被接收。

![[Snipaste_240312_094850.png|500]]

套接字是建立网络应用程序的可编程接口，因此也称为应用程序和网络之间的 API。

#### 进程寻址

为了标识接收进程的地址，需要指定：

- 主机的地址：**IP 地址**(IP address)。
- 接收进程在该主机中的标识符：**端口号**(port number)。

常见端口号：

- Web 服务器：`80`。
- 邮件服务器：`25`。

### 可供应用程序使用的运输服务

#### 可靠数据传输

**可靠数据传输**(reliable data transfer)：确保由应用程序的一端发送的数据正确、完整地交给另一端。

运输层协议向应用程序提供进程到进程的可靠数据传输。

#### 吞吐量

可用吞吐量：发送进程能够向接收进程交付比特的速率。

运输层协议能以特定速率提供确保的可用吞吐量。

#### 定时

例如，保证每个比特到达接收方的套接字不迟于 $100$ ms。

#### 安全性

在发送和接收进程间提供机密性，以防该数据在传输途中被观察到。

### 因特网提供的运输服务

因特网为应用程序提供 2 个运输层协议：TCP 和 UDP。

#### TCP 服务

- 面向连接的服务：在应用层数据报文开始传输前，TCP 让客户和服务器交换运输层控制信息，称为握手。握手之后，一条全双工的 TCP 连接在两进程的套接字之间建立。报文发送结束后，该连接需要拆除。
- 可靠的数据传输服务：无差错、按正确顺序交付所有发送的数据。

网络拥塞时，TCP 的拥塞控制机制将抑制发送进程。TCP 还会限制每一个 TCP 连接，使网络公平共享。

**安全套接字层**(Secure Sockets Layer，SSL)：TCP 的加强版本，提供了关键的进程间安全服务。

#### UDP 服务

UDP 是只提供最小必要服务的轻量级协议，是无连接的（因此无握手过程）。

UDP 提供一种不可靠的数据传输服务，无法保证报文的正确性、完整性或到达顺序。

#### 因特网运输协议所不提供的服务

因特网通常能提供可靠数据传输与安全性服务，而不保证吞吐量或定时服务。

### 应用层协议

**应用层协议**(application-layer protocol) 定义了进程间如何交换报文：

- 交换的报文类型
- 各种报文类型的语法，如各个字段的表达方式
- 字段的语义
- 发送报文的时间和方式，进行响应的规则

应用层协议只是网络应用的一部分。

| 应用     | 应用层协议   | 运输协议      |
| ------ | ------- | --------- |
| 电子邮件   | SMTP    | TCP       |
| 远程终端访问 | Telnet  | TCP       |
| Web    | HTTP    | TCP       |
| 文件传输   | FTP     | TCP       |
| 流媒体    | HTTP    | TCP       |
| 网络电话   | SIP，RTP | TCP 或 UDP |
## Web 和 HTTP

1990s，**万维网**(World Wide Web) 诞生，简称 Web，是一个因特网应用。

不同于无线电广播或电视的用户只能被动接收内容，Web 是按需操作的，用户可以主动获取想要的内容。

### HTTP 概况

**超文本传输协议**(HyperText Transfer Protocol，HTTP)：Web 的应用层协议，是 Web 的核心。

HTTP 由客户程序和服务器程序实现。

术语：

- **对象**：一个文件，如一个 HTML 文件、一个 JPEG 图形、一个 Java Applet 等，可通过一个 URL 地址寻址。
- **Web 页面**：也称文档，由若干对象组成，一般含一个 HTML 基本文件和若干引用对象。

HTTP 定义了 Web 客户向 Web 服务器请求 Web 页面的方式，以及服务器向客户传送页面的方式。

HTTP 使用 TCP 作为其支撑运输协议，采用客户 - 服务器程序体系结构。

HTTP 不保存关于客户的信息，属于 **无状态协议**(stateless protocol)。

### 非持续连接和持续连接

每个请求 / 响应对经由——

- 一个单独的 TCP 连接发送：**非持续连接**(non-persistent connection)。
- 同一个 TCP 连接发送：**持续连接**(persistent connection)。

#### 采用非持续连接的 HTTP

假设一个被请求的页面含 $1$ 个 HTML 基本文件和 $10$ 个引用对象：

1. 客户进程在端口 `80` 发起一个到服务器的 TCP 连接，随后该连接建立。
2. 客户经其套接字向服务器发送一个 HTTP 请求报文。
3. 服务器经其套接字接收该请求报文，从其存储器中检索出请求的对象，在一个 HTTP 响应报文中进行封装，通过其套接字向客户端发送该响应报文。
4. 服务器进程通知 TCP 断开该 TCP 连接（不过此时尚未断开，直到 TCP 确保客户无误地接收完成）。
5. 客户接收该响应报文，随后关闭 TCP 连接。
6. 客户解析响应报文，发现有 $10$ 个对象，对每一个重复步骤 1 ~ 5。
7. 全部完成后，将 Web 页面显示给用户。

本例中，一次 Web 页面的请求导致了 $11$ 个 TCP 连接的建立。

不同的浏览器可能会以不同的方式解释同一个页面，解释的过程与 HTTP 无关。

实际上，浏览器一般可以打开 $5$ ~ $10$ 个并行的 TCP 连接，每个连接处理一个请求响应事务。

**往返时间**(Rount-Trip Time，RTT)：一个短分组（忽略传输时延）从客户到服务器再返回客户所花费的时间，包括了其余 3 种时延（结点处理、排队、传播）。

“三次握手”：客户向服务器发送一个小的 TCP 报文段，服务器用一个小 TCP 报文段作出响应和确认，客户再向服务器返回确认。

请求一个对象的总响应时间约为 $2$ 个 RTT，第 1 个用于建立 TCP 连接，第 2 个用于请求和接收该对象：

![[Snipaste_240312_184516.png|450]]

#### 采用持续连接的 HTTP

如果采用持续连接，服务器在发送响应后保持该 TCP 连接打开，使得客户的后续请求和服务器的响应报文无需反复新建、断开更多的 TCP 连接。

HTTP 默认使用带流水线的持续连接。

### HTTP 报文格式

HTTP 报文分为 **请求报文** 和 **响应报文**。

#### HTTP 请求报文

```text
GET /somedir/page.html HTTP/1.1
Host: www.someschool.edu
Connection: close
User-agent: Mozilla/5.0
Accept-language: fr
```

![[Snipaste_240319_084852.png|500]]

HTTP 请求报文的首行称为 **请求行**(request line)，随后的几行称为 **首部行**(header lines)，在一个额外的空行之后可能有 **实体体**(entity body)。

- 请求行
	- 方法字段：取 `GET` / `POST` / `HEAD` / `PUT` / `DELETE`。
	- URL 字段：请求对象的标识。
	- HTTP 版本字段。
- 首部行
	- `Host`：对象所在的主机。
		- 已有连接的前提下，似乎不必要，但其实是 Web 代理高速缓存所要求的。
	- `Connection`：可选 `close` / `keep-alive`，控制是否采用持续连接。
	- `User-agent`：客户端代理标识，表示客户端所使用的浏览器，以便服务器返回对象的特定版本。
	- `Accept-language`：接受的语言，此为法语。
- 实体体：使用 POST 方法提交表单（如使用搜索引擎查询）时，会用到实体体，此时服务器根据用户的请求返回特定的内容。

更多方法字段：

- `HEAD`：类似于 `GET`，但不返回对象，用于调试。
- `PUT`：上传对象到服务器。
- `DELETE`：删除服务器中的对象。

#### HTTP 响应报文

```text
HTTP/1.1 200 OK
Connection: close
Date: Tue, 09 Aug 2011 15:44:04 GMT
Server: Apache/2.2.3 (Centos)
Last-Modified: Tue, 09 Aug 2011 15:11:03 GMT
Content-Length: 6821
Content-Type: text/html
```

![[Snipaste_240319_084910.png|500]]

HTTP 响应报文的首行称为 **状态行**(status line)，其后的首部行和实体体与 HTTP 请求报文相同。

- 状态行
	- HTTP 版本字段。
	- 状态码和相应的状态短语：
		- `200 OK`
		- `301 Moved Permanently`
		- `400 Bad Request`
		- `404 Not Found`
- 首部行
	- `Date`：报文本身产生的时间。
	- `Server`：服务器信息。
	- `Last-Modified`：对象最后修改的时间。
		- 用于更新 Web 缓存。
	- `Content-Length` 和 `Content-Type` 含义如字面所示。

### 用户与服务器的交互：cookie

cookie 使得无状态的 HTTP 得以标识用户。

cookie 技术包含的组件：

- HTTP 请求报文和响应报文的首部行。
- 客户端系统中的一个文件，由浏览器管理。
- 服务器端系统的数据库。

![[Snipaste_240319_102205.png|500]]

### Web 缓存



### 条件 GET 方法

## 文件传输协议：FTP

## 因特网中的电子邮件

### SMTP