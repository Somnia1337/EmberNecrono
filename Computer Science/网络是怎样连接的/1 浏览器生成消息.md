👈 [[0 概览]]

> ——探索浏览器内部

关键词：

> 浏览器，Web 服务器，网址(URL)，HTTP，HTML，协议，URI，请求消息，解析器，Socket 库，DNS 服务器，域名

看点：

![[Snipaste_231231_151952.png|600]]

> 浏览器如何解析网址
> 
> 请求消息实际的样子
> 
> 浏览器如何向 DNS 服务器查询域名对应的 IP 地址
> 
> DNS 服务器如何完成 IP 地址的查询
> 
> 浏览器如何将消息委托给操作系统发送给 Web 服务器

结构：

> - 生成 HTTP 请求消息
> 	- 探索之旅从输入网址开始
> 	- 浏览器先要解析 URL
> 	- 省略文件名的情况
> 	- HTTP 的基本思路
> 	- 生成 HTTP 请求消息
> 	- 发送请求后会收到响应
> - 向 DNS 服务器查询 Web 服务器的 IP 地址
> 	- IP 地址的基本知识
> 	- 域名和 IP 地址并用的理由
> 	- Socket 库提供查询 IP 地址的功能
> 	- 通过解析器向 DNS 服务器发出查询
> 	- 解析器的内部原理
> - 全世界 DNS 服务器的大接力
> 	- DNS 服务器的基本工作
> 	- 域名的层次结构
> 	- 寻找相应的 DNS 服务器并获取 IP 地址
> 	- 通过缓存加快 DNS 服务器的响应
> - 委托协议栈发送消息
> 	- 数据收发操作概览
> 	- 创建套接字阶段
> 	- 连接阶段：把管道接上去
> 	- 通信阶段：传递消息
> 	- 断开阶段：收发数据结束

### 生成 HTTP 请求消息

#### 探索之旅从输入网址开始

**统一资源定位符** | Uniform Resource Locator | **URL**：开头的字段指示浏览器要使用的访问方法（协议），以“http:”开头时就是通常所说的“网址”，还有“ftp:”、“file:”等开头。

**协议** | protocol：通信操作的规则定义。

**超文本传送协议** | Hypertext Transfer Protocol | **HTTP**：访问 Web 服务器时使用的协议。

**文件传送协议** | File Transfer Protocol | **FTP**：传输文件时使用的协议。

#### 浏览器先要解析 URL

以 `http://www.lab.glasscom.com/dirl/filel.html` 为例：

![[Snipaste_231228_194658.png|500]]

这个 URL 表示：要访问 `www.lab.glasscom.com` 这个 Web 服务器上路径名为 `/dir/file1.html` 的文件。

#### 省略文件名的情况

```text
http://www.example.com/dir/ -> 访问 /dir 目录
http://www.example.com/ -> 访问 / 目录
http://www.example.com -> 访问 / 目录
http://www.example.com/abc -> 访问根目录下的文件 abc, 或者目录 /abc
http://www.example.com/abc/ -> 访问目录 /abc
```

这些是省略了文件名的 URL，服务器会事先设置省略文件名时的默认文件。

#### HTTP 的基本思路

HTTP 定义了客户端和服务器之间交互的消息内容和步骤。

HTTP 的基本思路：

1. 客户端向服务器发送请求消息，后者包含两部分内容：
	- “对什么”：**统一资源标识符** | Uniform Resource Identifier | **URI**，表示请求访问的目标。
	- “进行怎样的操作”：**方法**，表示请求让 Web 服务器完成的工作的类型（主要方法见下表）。
2. 收到请求消息之后，Web 服务器会对其中的内容进行解析，通过 URI 和方法来判断“对什么”、“进行怎样的操作”，并根据这些要求完成响应，将结果存放在响应消息中。
3. 响应消息被发送回客户端，客户端收到之后，浏览器从消息中读出所需的数据并显示在屏幕上。

![[Snipaste_231229_145845.png|500]]

#### 生成 HTTP 请求消息

HTTP 消息的格式：

![[Snipaste_231229_150330.png|500]]

浏览器将根据当前的工作状态（例如点击超链接或表单的提交按钮）判断使用的方法。

#### 发送请求后会收到响应

响应消息的第一行含有状态码和响应短语，二者都表示请求的执行结果是否成功，但用途不同：

- 状态码：一个数字，用来告知程序。
- 响应短语：一段文字，用来告知用户。

![[Snipaste_231229_151250.png|500]]

每条请求消息中只能写 1 个 URI，所以每次只能获取 1 个文件。如果一个网页中包含 3 张图片，那么获取网页加上图片，一共需要向 Web 服务器发送 4 条请求。

### 向 DNS 服务器查询 Web 服务器的 IP 地址

#### IP 地址的基本知识

虽然浏览器能解析网址并生成 HTTP 消息，但它无法将消息发送到网络中，需要委托 OS 实现。生成 HTTP 消息之后，要根据域名查询 IP 地址。

IP 地址：包含网络号和主机号的整体，网络中的每台设备的 IP 地址唯一。可以通过 IP 地址判断访问对象服务器的位置。

消息发送的过程（简化版）：

1. 消息经过子网中的集线器转发到最近的路由器。
2. 每台路由器根据目的地判断下一个路由器的位置并发送，逐个接力，重复这 2 步。

![[Snipaste_231229_152401.png|400]]

IP 地址是一串 32 比特的数字，按 8 比特一组分为 4 组。网络号和主机号连起来总共 32 比特，但具体比例不固定，需要附加信息来确定，称为子网掩码。

子网掩码左侧都是 `1`，右侧都是 `0`，为 `1` 的部分对应 IP 的网络号，为 `0` 的部分对应 IP 的主机号。

![[Snipaste_231229_152856.png|500]]]

可以用如下方法表示子网掩码：

![[Snipaste_231229_152951.png|500]]

主机号部分的特殊情况：

- 全为 `0`：代表整个子网，而非某台设备。
- 全为 `1`：代表向子网中的所有设备发送包，即广播。

#### 域名和 IP 地址并用的理由

域名的优点：易于记忆。

IP 的优点：空间效率高。

**域名服务系统** | Domain Name System | **DNS**：通过域名查询 IP 地址的机制。

#### Socket 库提供查询 IP 地址的功能

查询 IP 地址的方法非常简单，只需询问 DNS 服务器“`www.lab.glasscom.com` 的 IP 地址是什么”，后者就会回答说“该服务器的 IP 地址为 `xxx.xxx.xxx.xxx`”。

既然向 DNS 服务器发送查询消息，那么本地计算机上一定有 DNS 客户端，也称 DNS 解析器(因为通过 DNS 查询 IP 的操作称为解析)。

解析器实际上是一段程序，它包含在操作系统的 Socket 库中，后者是用于调用网络功能的程序组件集合，而解析器就是这个库中的其中一种程序组件。

> 库是一个通用程序组件的集合，应用程序可以使用其中的组件。

#### 通过解析器向 DNS 服务器发出查询

调用解析器后，解析器会向 DNS 服务器发送查询消息，然后 DNS 服务器会返回响应消息。响应消息中包含查询到的 IP 地址，解析器会取出 IP 地址，并将其写入浏览器指定的内存地址中。

#### 解析器的内部原理

![[Snipaste_231229_182058.png|500]]

向 DNS 服务器发送消息时，当然需要首先知道 DNS 服务器的 IP 地址，它是作为 TCP/IP 的一个设置项事先设置好的。

![[Snipaste_231229_182259.png|400]]

### 全世界 DNS 服务器的大接力

#### DNS 服务器的基本工作

来自客户端的查询消息包括：

- 域名：目标服务器的名称。
- Class：用来识别网络信息，不过今天只剩下互联网一个网络了，因此其值永远是 `IN`。
- 记录类型：表示域名对应哪种类型的记录，如 `A` 表示对应的是 IP 地址。

> 很多 Web 服务器的域名以 `www` 开头，这不是必须的，而是因为最开始很多 Web 服务器都采用了 `www`，形成了惯例。

#### 域名的层次结构

域名的句点表示不同层次之间的界限，以 `www.lab.glasscom.com` 为例，如果按照公司的组织结构，可能就是：

- `com` 事业集团 `glasscom` 部 `lab` 科的 `www`。
- `com` 域 -> `glasscom` 域 -> `lab` 域 -> `www` 名字。

以实际的 `www.nikkeibp.co.jp` 为例：

- `jp`：日本国的域，表示日本。
- `co`：在日本国内细分的域，表示公司。
- `nikkeibp`：公司的域，此为公司名。
- `www`：服务器名。

域名在 DNS 服务器中是作为一个整体存在、不可分割的，如果有细分的需求，可以创建下级域，如为 `nikkeibp.co.jp` 创建两个子域 `sub1.nikkeibp.co.jp` 和 `sub2.nikkeibp.co.jp`。

#### 寻找相应的 DNS 服务器并获取 IP 地址

管理下级域的 DNS 服务器的 IP 将被注册到上级 DNS 服务器，层层递推。

根域：互联网的顶级域，没有名字但真实存在，如果要表示，须在域名最后再加上一个句点，如 `www.lab.glasscom.com.`，分配给根域的 IP 共 13 个。

![[Snipaste_231229_184405.png|400]]

![[Snipaste_231229_184505.png|400]]

#### 通过缓存加快 DNS 服务器的响应

DNS 服务器将最近查询的域名记录在缓存中，如果命中，就可以直接调用。

由于原本的注册信息可能发生改变，缓存有一个过期时间。

### 委托协议栈发送消息

#### 数据收发操作概览

向 OS 内部的协议栈发出委托时，需要按照一定的顺序调用 Socket 库的组件。

收发数据的过程类似于在两台计算机之间建立一条数据通道，数据沿着通道流通。

![[Snipaste_231230_182042.png|500]]

建立管道的关键在于管道两端的出入口，称为套接字。大致过程为：

1. 创建套接字(创建套接字阶段)
2. 将管道连接到服务器端的套接字上(连接阶段)
3. 收发数据(通信阶段)
4. 断开管道并删除套接字(断开阶段)

![[Snipaste_231230_183027.png|500]]

#### 创建套接字阶段

调用 Socket 库的 `socket` 组件后，套接字就创建好了，此时协议栈会返回一个描述符，后者用于识别不同的套接字，因为计算机可能同时与很多服务器通信，需要用描述符识别不同的套接字。

#### 连接阶段：把管道接上去

调用 `connect` 组件将客户端和服务端的套接字连接起来，调用时需要指定 3 个参数：描述符，服务器 IP，端口号。

端口号：用 IP 可以找到网络中的一台设备，但是设备可以有很多套接字，需要通过端口号确定具体要连接的套接字。

概括：

- 描述符：应用程序用来识别套接字的机制。
- IP 地址和端口号：客户端和服务器之间用来识别对方套接字的机制。

#### 通信阶段：传递消息

调用 `write` 组件发送数据，再用 `read` 组件接收返回数据。

#### 断开阶段：收发数据结束

调用 `close` 组件断开套接字之间的连接。HTTP 规定，Web 服务器发送完响应消息后，应主动断开连接，具体过程(`close` 调用的先后顺序不总是这样)：

1. Web 服务器发送响应消息。
2. Web 服务器调用 `close`。
3. 断开操作传达到客户端，客户端的套接字进入断开阶段。
4. 浏览器调用 `read`，后者提示收发数据的操作结束，浏览器调用 `close`。

#### 小结

以上就是 HTTP 的工作过程总览，每个文档、每张图片都是单独的对象，因此每次收发数据都要进行完整的连接、请求、响应、断开的过程。在 HTTP 1.1 以后，能够在一次连接中进行多次请求与响应操作。

👉 [[2 用电信号传输 TCP IP 数据]]