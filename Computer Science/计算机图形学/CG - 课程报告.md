## 1 概述

> [!example] 要求
> 
> - 对项目做一个简要介绍，包含完成的功能，采用的主要技术和方法。
> - 展示运行程序达到的最佳效果（附主要运行界面截图）。

本项目的核心目标是实现一个可实时交互的 3D 场景渲染。项目 100% 基于 Rust 语言以及 `three-d` 绘图库，充分利用了 Rust 的性能优势，实现了一个可用键鼠交互的、提供 GUI 参数控制面板的、高帧率的 3D 场景建模。

技术亮点：

- 多种建模
    - shader（8 色立方体）
    - 高级 API（镜面球）
    - 资源文件（小黄鸭 & 小螃蟹）
- 渲染技术
    - 多光源动态渲染
    - 多种光照计算模型（Blinn-Phong / Cook-Torrance）
    - 实时阴影生成
- 交互与调试
    - 鼠标控制的相机系统
    - 键盘控制的场景漫游
    - 实时 GUI 参数调试面板
    - 帧率计算
- 编程实现
    - 类型安全的图形渲染接口
    - 高效的内存管理
    - 异步编程（资源加载）

![[Snipaste_241219_083800.png]]

![[Snipaste_241219_083826.png]]

## 2 设计

> [!example] 要求
> 
> 先给出整体系统硬件和软件的总体设计，然后就软件层次的各个组成部分给出详细设计。

### 2.1 整体设计

> [!example] 要求
> 
> 抽象出整体设计框架，绘制出整体架构图，并给出简要描述。

![[three-d-scene_系统架构.png]]

系统主要分为：

- 资源系统：场景的模型、纹理等资源管理
- 光照系统：光照的计算与动态调整
- 渲染系统：渲染场景、阴影、Mipmap 以及动画效果
- 交互系统：管理人机交互，包括键鼠控制和 GUI 参数控制面板

> [!error] 绘图

### 2.2 详细设计

#### 2.2.1 交互设计

> [!example] 要求
> 
> - 列出主要的交互物理设备有哪些，程序主要的交互操作有哪些。
> - 列出交互相关的操作功能（监听程序的响应操作）。

主要的交互物理设备：

- 键盘：控制相机移动、重置视角、切换动画状态等。
- 鼠标：调整相机视角，支持旋转、缩放等操作。
- 显示器：渲染三维场景以及显示 GUI 控制台内容，包括参数调整和信息展示。

主要的交互操作：

- 键盘输入
    - W/A/S/D 或方向键：控制相机前后左右移动。
    - 空格：控制相机上升；同时按下 `Shift` 时控制相机下降。
    - R：重置相机至初始位置。
- 鼠标输入：
    - 调整相机视角（通过拖拽）。
    - 实现视角的动态缩放（通过滚轮）。
- GUI 控制台交互
    - 实时调整光照强度、材质参数（如金属度、粗糙度）。
    - 切换两种光照模型。
    - 开关动画、切换平面材质（普通平面与棋盘格）。
- FPS 监控
    - 显示当前和平均帧率，帮助优化性能。

监听程序的响应操作：

- 键盘事件监听
    - 处理相机方向向量的计算，并调整相机位置。
    - 检测组合键（如 `Shift + 空格`），执行特殊动作。
    - 重置相机到初始位置。
- 鼠标事件监听
    - 根据鼠标移动事件调整相机视角。
    - 根据滚轮输入调整场景缩放比例。
- GUI 交互监听
    - 滑块的值变动会触发实时更新光照强度、材质参数等。
    - 单选框的切换会实时更新光照模型或插值方式。
    - 按钮点击会触发参数重置或启用棋盘格平面。
- FPS 监控：在渲染循环中每 `0.2s` 更新实时 FPS 和平均 FPS，通过 GUI 实时显示。

#### 2.2.2 场景设计

> [!example] 要求
> 
> - 场景包含三种以上的物体（造型方法如网格、分形，样条曲线曲面等）和至少 1 个光源，绘制“场景图”。
> - 阐述每种几何建模方法是如何得到顶点的（如果是导入的模型，需要解释模型文件的结构和含义。如果是自建的，需要给出建立的方法）。

使用了多种几何建模方法来创建不同的三维对象，包括导入的模型、自建模型以及调用库的高级 API：

- 小黄鸭和小螃蟹使用了 `.glb` 模型文件。这些模型文件是通过外部建模工具（如 Blender）创建并导出的。`.glb` 文件是 GLTF（GL Transmission Format）的二进制版本，包含了模型的几何数据、材质、纹理和动画等信息。在代码中，通过 Gm::new 方法加载这些模型，并将其添加到场景中。
- 镜面球通过调用 `three-d` 库的高级 API 创建。`three-d` 库提供了方便的函数来生成常见的几何体，如球体、立方体、平面等。
- 立方体通过手写 Shader 创建。手动定义了立方体的顶点数据和索引数据，并编写了自定义的 Shader 来渲染立方体。

#### 2.2.3 观察设计

> [!example] 要求
> 
> - 阐述场景中每个几何模型的模型变换矩阵是怎样设计。
> - 阐述场景中的相机变换矩阵是怎样设计。
> - 阐述场景中的投影变换矩阵是怎样设计。

几何模型的模型变换矩阵（矩阵运算都是调用 three-d 的 `Mat4::from` 系列方法）：

- 立方体的变换矩阵包括平移和缩放操作，并且设置了动画使其绕 Y 轴旋转。
- 小黄鸭和 `ferris` 使用了导入的 `.glb` 模型文件，其变换矩阵也包括平移和缩放操作。
- 球体通过调用 `three-d` 库的高级 API 创建，其变换矩阵也包括平移和缩放操作。

场景中的相机变换矩阵设计：相机的变换矩阵定义了相机在场景中的位置和方向，以及键鼠控制的平移和旋转操作，以便从不同角度观察场景。

场景中的投影变换矩阵设计：投影变换矩阵定义了场景的投影方式，我采用了透视投影。

#### 2.2.4 着色设计

> [!example] 要求
> 
> - 采用一个或多个光源进行场景光照颜色计算（含阴影），对采用的光照计算模型进行描述。
> - 要求有场景中某物体表面的纹理贴图效果，描述采用的方法。
> - 其它的特效功能，如全局光照，透明，雾化， 凹凸贴图，景深等。

每种光源单独照射的效果：

![[Snipaste_241219_084032.png]]

![[Snipaste_241219_084056.png]]

![[Snipaste_241219_084106.png]]

通过 GUI 面板切换棋盘格地板，然后可以更改 Mipmap 等级和方式：

![[Snipaste_241219_084319.png]]

![[Snipaste_241219_084347.png]]

## 3 实现

> [!example] 要求
> 
> - 说明采用的开发环境，开发工具，开发语言，以及使用的框架等，注明参考出处。
> - 列出实现的关键和主要的代码和效果图，并给出对应的文字说明。

- 开发环境：Windows 11，版本 23H2
- 开发工具：Visual Studio Code（Rust Analyzer 插件）
- 开发语言：Rust，版本 1.83.0
- 依赖库：[three-d](https://github.com/asny/three-d)
- 资源文件源
    - 模型：[glTF Sample Models](https://github.com/KhronosGroup/glTF-Sample-Models)
    - 天空盒：[Poly Haven](https://polyhaven.com/)

## 4 总结

> [!example] 要求
> 
> - 对项目完成情况做出总体评价，总结完成过程中遇到的问题，解决方法等。
> - 总结本课程学习的主要收获，可绘制“知识图谱”。
> - 提出对课程授课内容和授课方式的建议。

本项目以 Rust 语言和 three-d 绘图库为核心，成功实现了一个高性能实时交互的 3D 场景漫游系统，包含几何建模、真实感渲染和多样化交互功能。

项目完成情况：

- 实现的功能：项目全面实现了建模、渲染和交互功能。
    - 几何建模：通过自建模型（立方体、镜面球）和导入模型（小黄鸭、小螃蟹）结合，展现了多种建模方式。
    - 光照系统：支持环境光、平行光、点光源，并实现了动态光照参数调节。
    - 渲染效果：使用 Blinn-Phong 和 Cook-Torrance 光照模型，提供了高质量的真实感渲染；提供 Mipmap 解决走样问题。
    - 交互系统：设计了键鼠控制的场景漫游和 GUI 参数调试面板，增强了可用性和灵活性。
- 遇到的问题和解决方法
    - shader 与高级 API 结合：由于必须使用 shader，需要底层调用与高级调用共存，存在各种冲突。通过学习库的官方示例程序发现了同时使用二者的写法，解决了不共存问题。
    - 动画暂停与恢复错误：添加动画暂停功能时，发现恢复动画存在跳变，分析发现原因为动画基于时间计算三角函数值，恢复后读取当前时刻，与暂停的时刻相差周期不是整数。通过定义 3 个额外的变量记录累计暂停的时长，动画恢复后从当前时刻减去该差值，矫正了周期不一致的问题。

课程学习收获：

- 理论结合实践
    - 理解了几何建模的数学基础，如模型变换矩阵和投影变换矩阵的构造。
    - 深入学习了光照模型的原理及其在渲染中的实现方法。
- 编程技能提升
    - 掌握了 Rust 的异步编程、内存管理和高效的图形接口使用方法。
    - 熟悉了 `three-d` 图形库的基本用法和高级功能。
- 综合能力的提高
    - 通过构建完整的渲染流水线，提升了系统设计能力和调试能力。
    - 学会利用文档和社区资源解决实际问题。

对课程的建议：

- 保持开放性：课程项目不限制题目、不限制语言或平台，为不同学习背景和专业能力的学生提供了多样化的选择（比如允许我使用 Rust），建议保持。
- 其它都做得很棒！

## 参考文献

- Tomas Akenine-Möller, Eric Haines, Naty Hoffman. Real-Time Rendering (4th Edition). A K Peters/CRC Press, 2018.
- Foley, James D., et al. Computer Graphics: Principles and Practice (3rd Edition). Addison-Wesley Professional, 2013.
- Cook, Robert L., and Torrance, Kenneth E., "A Reflectance Model for Computer Graphics.", ACM Transactions on Graphics (TOG), vol. 1, no. 1, 1982, pp. 7–24.
- Phong, Bui Tuong., "Illumination for Computer Generated Pictures.", Communications of the ACM, vol. 18, no. 6, 1975, pp. 311–317.
