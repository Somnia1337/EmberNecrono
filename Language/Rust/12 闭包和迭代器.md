ğŸ‘ˆ [[11 æ ¼å¼åŒ–è¾“å‡º]]

## é—­åŒ…

### ç”¨é—­åŒ…ç®€åŒ–ä»£ç 

é—­åŒ…(Closure)ï¼šä¸€ç§åŒ¿åå‡½æ•°ï¼Œå¯ä»¥èµ‹å€¼ç»™å˜é‡ï¼Œä¹Ÿå¯ä½œä¸ºå‚æ•°ä¼ é€’ç»™å…¶ä»–å‡½æ•°ï¼Œä¸åŒäºå‡½æ•°çš„æ˜¯ï¼Œå®ƒå¯ä»¥æ•è·è°ƒç”¨è€…ä½œç”¨åŸŸä¸­çš„å€¼ï¼š

```rust
let x = 1;
let sum = |y| x + y;
assert_eq!(3, sum(2));
```

`sum` æ˜¯ä¸€ä¸ªé—­åŒ…ï¼Œå®ƒæœ‰ä¸€ä¸ªå…¥å‚ `y`ï¼ŒåŒæ—¶æ•è·äº†ä½œç”¨åŸŸä¸­ `x` çš„å€¼ï¼Œè°ƒç”¨ `sum(2)` æ„å‘³ç€å°† `2` ä¸ `1` ç›¸åŠ ï¼Œè¿”å› `3`ã€‚

```text
|param1, param2, ...| {
    è¯­å¥ 1;
    è¯­å¥ 2;
    è¿”å›è¡¨è¾¾å¼
}

|params ...| è¿”å›è¡¨è¾¾å¼
```

`let sum = ||...` æ˜¯å°†é—­åŒ…æœ¬èº«ï¼ˆè€Œä¸æ˜¯å…¶è¿”å›å€¼ï¼‰èµ‹ç»™å˜é‡ `sum`ï¼Œå¯ä»¥åƒè°ƒç”¨å‡½æ•°ä¸€æ ·è°ƒç”¨ `sum()`ã€‚

### é—­åŒ…çš„ç±»å‹æ¨å¯¼

é—­åŒ…ä¸åƒå‡½æ•°ä½œä¸º API å¯¹å¤–æä¾›ï¼Œå› æ­¤æ— éœ€æ‰‹åŠ¨æ ‡æ³¨å‚æ•°åŠè¿”å›å€¼ç±»å‹ã€‚

å®ç°â€œè¾“å…¥ `x`ï¼Œè¿”å› `x + 1`â€çš„å‡ ä¸ªå‡½æ•°åŠé—­åŒ…ï¼š

```rust
fn add_one_v1 (x: u32) -> u32 { x + 1 }
let add_one_v2 = |x: u32| -> u32 { x + 1 };
let add_one_v3 = |x| { x + 1 };
let add_one_v4 = |x| x + 1;
```

### ç»“æ„ä½“ä¸­çš„é—­åŒ…

å®ç°ä¸€ä¸ªç®€æ˜“ç¼“å­˜ï¼Œç”¨ä¸€ä¸ªé—­åŒ…è·å–å€¼ï¼Œå†å­˜å…¥ä¸€ä¸ªå˜é‡ï¼Œç¼“å­˜å¯¹è±¡å¯ç”¨ç»“æ„ä½“è¡¨ç¤ºï¼š

```rust
struct Cacher<T>
where
	T: Fn(u32) -> u32, // ç‰¹å¾çº¦æŸ, è¡¨ç¤º T æ˜¯ä¸€ä¸ªé—­åŒ…æˆ–å‡½æ•°ç±»å‹
{
	query: T,
	value: Option<u32>,
}
```

```rust
impl<T> Cacher<T>
where
    T: Fn(u32) -> u32,
{
    fn new(query: T) -> Cacher<T> {
        Cacher {
            query,
            value: None,
        }
    }
	
    // å…ˆæŸ¥è¯¢ç¼“å­˜å€¼ `self.value`, è‹¥ä¸å­˜åœ¨, åˆ™è°ƒç”¨ `query` åŠ è½½
    fn value(&mut self, arg: u32) -> u32 {
        match self.value {
            Some(v) => v,
            None => {
                let v = (self.query)(arg); // é—­åŒ…è°ƒç”¨
                self.value = Some(v);
                v
            }
        }
    }
}
```

### æ•è·ä½œç”¨åŸŸä¸­çš„å€¼

```rust
fn main() {
	let delta = 2;
	let add = |x| x + delta;
	let a = 1;
	println!("{}", add(a));
}
```

`delta` å¹¶ä¸æ˜¯ `add` çš„å‚æ•°ï¼Œä½†åè€…ä½äºå®ƒçš„ä½œç”¨åŸŸå†…ï¼Œå› æ­¤å¯å°†å®ƒæ•è·ï¼Œè€Œå‡½æ•°å°±æ— æ³•åšåˆ°ï¼š

```rust
fn main() {
    let delta = 2;
    fn add(x: i32) -> i32 {
        x + delta // error
    }
    let a = 1;
    println!("{}", add(a));
}

// error[E0434]: can't capture dynamic environment in a fn item
```

ä¸èƒ½å¯¹åŒä¸€é—­åŒ…ä½¿ç”¨ä¸åŒç±»å‹è¿›è¡Œè°ƒç”¨ï¼š

```rust
let a_closure = |x| x;

let s = a_closure(String::from("hello")); // ok // ç¡®å®š x: String
let n = a_closure(5); // error
```

æ•è·å¯å˜å¼•ç”¨çš„é—­åŒ…ï¼š

```rust
let mut list = vec![1, 2, 3];
println!("before defining closure: {:?}", list); // ä¸å¯å˜å€Ÿç”¨, ç»“æŸ

let mut borrows_mutably = || list.push(7); // å¯å˜å€Ÿç”¨, å¼€å§‹
// è¿™é‡Œä¸èƒ½å†æœ‰ println("before calling closure: {:?}", list);
borrows_mutably(); // å¯å˜å€Ÿç”¨, ç»“æŸ
println!("after calling closure: {:?}", list); // ä¸å¯å˜å€Ÿç”¨, ç»“æŸ
```

### `move` å¼ºåˆ¶è·å–æ‰€æœ‰æƒ

`move` å¼ºåˆ¶é—­åŒ…è·å–æ‰€æœ‰æƒã€‚

æ–°çº¿ç¨‹å¯èƒ½åœ¨ä¸»çº¿ç¨‹å‰©ä½™éƒ¨åˆ†æ‰§è¡Œå®Œä¹‹å‰æ‰§è¡Œå®Œï¼Œæˆ–è€…ä¹Ÿå¯èƒ½ä¸»çº¿ç¨‹å…ˆæ‰§è¡Œå®Œã€‚å¦‚æœä¸»çº¿ç¨‹ç»´æŠ¤äº†Â `list`Â çš„æ‰€æœ‰æƒä½†å´åœ¨æ–°çº¿ç¨‹ä¹‹å‰ç»“æŸå¹¶ä¸”ä¸¢å¼ƒäº†Â `list`ï¼Œåˆ™å­çº¿ç¨‹ä¸­çš„ä¸å¯å˜å¼•ç”¨å°†å¤±æ•ˆï¼Œæ­¤æ—¶éœ€è¦å¼ºåˆ¶å°† `list` çš„æ‰€æœ‰æƒç§»åŠ¨åˆ°æ–°çº¿ç¨‹ï¼ˆä¹Ÿæ˜¯ç¼–è¯‘å™¨è¦æ±‚ï¼‰ã€‚

```rust
let list = vec![1, 2, 3];
println!("before defining closure: {:?}", list);

thread::spawn(move || println!("from thread: {:?}", list))
	.join()
	.unwrap();
```

### `Fn` trait

é—­åŒ…è‡ªåŠ¨ã€æ¸è¿›åœ°å®ç° 1 ~ 3 ä¸ªÂ `Fn`Â traitï¼š

- `FnOnce`ï¼šé€‚ç”¨äºèƒ½è¢«è°ƒç”¨ä¸€æ¬¡çš„é—­åŒ…ï¼Œæ‰€æœ‰é—­åŒ…éƒ½ **è‡³å°‘** å®ç°äº†è¿™ä¸ª traitï¼Œå› ä¸ºæ‰€æœ‰é—­åŒ…éƒ½èƒ½è¢«è°ƒç”¨ã€‚ä¸€ä¸ªä¼šå°†æ•è·çš„å€¼ç§»å‡ºé—­åŒ…ä½“çš„é—­åŒ…åªå®ç°Â `FnOnce`Â traitï¼Œè¿™æ˜¯å› ä¸ºå®ƒåªèƒ½è¢«è°ƒç”¨ä¸€æ¬¡ã€‚
- `FnMut`ï¼šé€‚ç”¨äºä¸ä¼šå°†æ•è·çš„å€¼ç§»å‡ºé—­åŒ…ä½“çš„é—­åŒ…ï¼Œä½†å®ƒå¯èƒ½ä¼šä¿®æ”¹è¢«æ•è·çš„å€¼ã€‚è¿™ç±»é—­åŒ…å¯ä»¥è¢«è°ƒç”¨å¤šæ¬¡ã€‚
- `Fn`ï¼šé€‚ç”¨äºæ—¢ä¸å°†è¢«æ•è·çš„å€¼ç§»å‡ºé—­åŒ…ä½“ä¹Ÿä¸ä¿®æ”¹è¢«æ•è·çš„å€¼çš„é—­åŒ…ï¼Œä¹ŸåŒ…æ‹¬ä¸ä»ç¯å¢ƒä¸­æ•è·å€¼çš„é—­åŒ…ã€‚è¿™ç±»é—­åŒ…å¯ä»¥è¢«è°ƒç”¨å¤šæ¬¡è€Œä¸æ”¹å˜å®ƒä»¬çš„ç¯å¢ƒï¼Œè¿™åœ¨ä¼šå¤šæ¬¡å¹¶å‘è°ƒç”¨é—­åŒ…çš„åœºæ™¯ä¸­ååˆ†é‡è¦ã€‚

## è¿­ä»£å™¨

**æ¶ˆè´¹é€‚é…å™¨**(consuming adaptors)ï¼šè°ƒç”¨Â `next()`Â çš„æ–¹æ³•ï¼Œä¼šæ¶ˆè€—è¿­ä»£å™¨ã€‚

```rust
let arr = vec![1, 2, 3];
let arr_iter = arr.iter();
let total: i32 = arr_iter.sum();
assert_eq!(total, 6);
// ä¸èƒ½å†ä½¿ç”¨ arr_iter
```

ğŸ‘‰ [[13 æ™ºèƒ½æŒ‡é’ˆ]]