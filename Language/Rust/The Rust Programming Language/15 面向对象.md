ğŸ‘ˆ [[14 å¹¶å‘]]

## é¡¾åŠä¸åŒç±»å‹å€¼çš„ trait å¯¹è±¡

### å®šä¹‰é€šç”¨è¡Œä¸ºçš„ trait

è®¾æƒ³ä¸€ä¸ª GUI ç¨‹åºï¼Œè¦éå†ä¸€ä¸ªå­˜å‚¨äº†å„ç§ UI å¯¹è±¡ï¼ˆå¦‚ `Button` å’Œ `TextField`ï¼‰çš„åˆ—è¡¨ï¼Œå¹¶å¯¹æ¯ä¸€é¡¹è°ƒç”¨ `draw()` æ‰“å°åœ¨å±å¹•ä¸Šã€‚

åœ¨å…¶ä»–é¢å‘å¯¹è±¡è¯­è¨€ä¸­ï¼Œå¯èƒ½æœ‰ä¸€ä¸ªè¶…ç±» `Component`ï¼Œå®ƒå®šä¹‰äº† `draw()`ï¼Œå„ç§ UI å¯¹è±¡ç±»ç»§æ‰¿è‡ª `Component`ã€‚

è¦åœ¨ Rust ä¸­å®ç°ï¼Œå¯ä»¥å®šä¹‰ä¸€ä¸ª `Draw` traitï¼Œå¹¶å°†å„ç§å®ç°äº† `Draw` çš„å¯¹è±¡å­˜å‚¨åœ¨ä¸€ä¸ªå¯ä»¥å­˜æ”¾ **trait å¯¹è±¡** çš„ vectorã€‚

å®šä¹‰ `Draw` traitï¼š

```rust
pub trait Draw {
    fn draw(&self);
}
```

å†å®šä¹‰ä¸€ä¸ªç»“æ„ä½“ `Screen`ï¼Œå…¶æˆå‘˜å˜é‡ `components` æ˜¯ä¸€ä¸ª vectorï¼Œå­˜å‚¨çš„ç±»å‹ä¸º `Box<dyn Draw>`ï¼Œåè€…æ˜¯ä¸€ä¸ª trait å¯¹è±¡ï¼Œå¯ä»¥æŒ‡ä»£ä»»ä½•å®ç°äº† `Draw` trait çš„ç±»å‹ï¼š

```rust
pub struct Screen {
    pub components: Vec<Box<dyn Draw>>,
}
```

ä¸º `Screen` å®ç° `run()`ï¼Œå¯¹ `components` ä¸­çš„æ¯ä¸ªå˜é‡è°ƒç”¨ `draw()`ï¼š

```rust
impl Screen {
    pub fn run(&self) {
        for component in self.components.iter() {
            component.draw();
        }
    }
}
```

å¯¹æ¯” trait å¯¹è±¡ä¸æ³›å‹ç±»å‹å‚æ•°ï¼ˆä¸‹ä¸ºæ³›å‹ç±»å‹å‚æ•°çš„é•œåƒå®ç°ï¼‰ï¼š

```rust
pub trait Draw {
    fn draw(&self);
}

pub struct Screen<T: Draw> {
    pub components: Vec<T>,
}

impl<T> Screen<T>
    where
        T: Draw,
{
    pub fn run(&self) {
        for component in self.components.iter() {
            component.draw();
        }
    }
}
```

å¯¹äºæ³›å‹ç±»å‹å‚æ•°å®ç°ï¼Œ`components` åªèƒ½å­˜å‚¨ä¸€ç§ç±»å‹çš„å˜é‡ï¼ˆç¼–è¯‘æ—¶å¯¹ `T` é‡‡ç”¨å…·ä½“ç±»å‹è¿›è¡Œå•æ€åŒ–ï¼‰ï¼Œè€Œ trait å¯¹è±¡åˆ™å®ç°äº†â€œçœŸæ­£çš„åŠ¨æ€â€ã€‚

### å®ç° trait

å®šä¹‰ä¸€ä¸ªç»“æ„ä½“ `Button` è¡¨ç¤ºä¸€ä¸ª UI æŒ‰é’®ï¼Œå¹¶å¯¹å…¶å®ç° `Draw` traitï¼š

```rust
pub struct Button {
    pub width: u32,
    pub height: u32,
    pub label: String,
}

impl Draw for Button {
    fn draw(&self) {
        // ä¼ªå®ç°
        println!("a Button of {}*{}: {}", self.width, self.height, self.label)
    }
}
```

å†å®šä¹‰ä¸€ä¸ªè¡¨ç¤ºå‹¾é€‰æ¡†çš„ `CheckBox`ï¼Œä¹Ÿå®ç° `Draw` traitï¼š

```rust
pub struct CheckBox {
    pub checked: bool,
}

impl Draw for CheckBox {
    fn draw(&self) {
        // ä¼ªå®ç°
        println!("{} CheckBox", if self.checked { "a checked" } else { "an unchecked" })
    }
}
```

ä¸€åˆ‡å‡†å¤‡å°±ç»ªï¼Œåœ¨ `main()` ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„ `Screen` å®ä¾‹ï¼Œå…¶åŒ…å«ä¸¤ä¸ª `Draw` trait å¯¹è±¡â€”â€”ä¸€ä¸ª `Button` å’Œä¸€ä¸ª `CheckBox`â€”â€”ç„¶åå¯¹å®ä¾‹è°ƒç”¨ `run()`ï¼š

```rust
fn main() {
    let screen = Screen {
        components: vec![
            Box::new(
                Button {
                    width: 50,
                    height: 50,
                    label: String::from("ğŸ¦€"),
                }
            ),
            Box::new(
                CheckBox {
                    checked: true,
                }
            ),
        ]
    };
    screen.run();
}
```

```text
a Button of 50*50: ğŸ¦€
a checked CheckBox
```

### trait å¯¹è±¡æ‰§è¡ŒåŠ¨æ€åˆ†å‘

å†æ¬¡å¯¹æ¯” trait å¯¹è±¡ä¸æ³›å‹ç±»å‹å‚æ•°ï¼š

- æ³›å‹ç±»å‹å‚æ•°ï¼šç¼–è¯‘æ—¶ `T` è¢«å•æ€åŒ–å¤„ç†ï¼Œç”Ÿæˆé™æ€ç±»å‹ä»£ç ï¼Œç§°ä¸º **é™æ€åˆ†å‘**(static dispatch)ã€‚
- trait å¯¹è±¡ï¼šç¼–è¯‘æ—¶æ— æ³•å¾—çŸ¥å…·ä½“çš„ç±»å‹ï¼Œç”Ÿæˆåœ¨è¿è¡Œæ—¶ç¡®å®šå…·ä½“æ–¹æ³•è°ƒç”¨çš„ä»£ç ï¼Œç§°ä¸º **åŠ¨æ€åˆ†å‘**(dynamic dispatch)ã€‚

## é¢å‘å¯¹è±¡è®¾è®¡æ¨¡å¼çš„å®ç°

**çŠ¶æ€æ¨¡å¼**(state pattern) æ˜¯ä¸€ç§é¢å‘å¯¹è±¡è®¾è®¡æ¨¡å¼ï¼Œå®ƒå®šä¹‰ä¸€ç³»åˆ—å€¼çš„å†…å«çŠ¶æ€ã€‚è¿™äº›çŠ¶æ€ä½“ç°ä¸ºä¸€ç³»åˆ—çš„Â **çŠ¶æ€å¯¹è±¡**ï¼ŒåŒæ—¶å€¼çš„è¡Œä¸ºéšç€å…¶å†…éƒ¨çŠ¶æ€è€Œæ”¹å˜ã€‚

æ¯ä¸€ä¸ªçŠ¶æ€å¯¹è±¡è´Ÿè´£å…¶è‡ªèº«çš„è¡Œä¸ºï¼Œä»¥åŠè¯¥çŠ¶æ€ä½•æ—¶åº”å½“è½¬ç§»è‡³å¦ä¸€ä¸ªçŠ¶æ€ã€‚

çŠ¶æ€æ¨¡å¼çš„ä¼˜ç‚¹ï¼šä¸šåŠ¡éœ€æ±‚æ”¹å˜æ—¶ï¼Œæ— éœ€æ”¹å˜å€¼æŒæœ‰çŠ¶æ€æˆ–ä½¿ç”¨å€¼çš„ä»£ç ï¼Œåªéœ€æ›´æ–°æŸä¸ªçŠ¶æ€å¯¹è±¡ä¸­çš„ä»£ç ä»¥æ”¹å˜å…¶è§„åˆ™ï¼Œæˆ–è€…æ˜¯å¢åŠ æ›´å¤šçš„çŠ¶æ€å¯¹è±¡ã€‚

ä¸‹é¢å®ç°ä¸€ä¸ªåšæ–‡å‘å¸ƒçš„åŠŸèƒ½ï¼š

- åšæ–‡ä»ç©ºç™½çš„è‰æ¡ˆå¼€å§‹ã€‚
- ä¸€æ—¦è‰æ¡ˆå®Œæˆï¼Œè¯·æ±‚å®¡æ ¸åšæ–‡ã€‚
- ä¸€æ—¦åšæ–‡è¿‡å®¡ï¼Œå®ƒå°†è¢«å‘è¡¨ã€‚
- åªæœ‰è¢«å‘è¡¨çš„åšæ–‡çš„å†…å®¹ä¼šè¢«æ‰“å°ã€‚

å·¥ä½œæµå¤§è‡´å¦‚ä¸‹ï¼š

```rust
let mut post = Post::new();

post.add_text("some content");
assert_eq!("", post.content());

post.request_review();
assert_eq!("", post.content());

post.approve();
assert_eq!("some content", post.content());
```

è¿˜æœªå®ç°çš„ `Post` ä¼šä½¿ç”¨çŠ¶æ€æ¨¡å¼å¹¶å­˜å‚¨å¤„äº 3 ç§åšæ–‡å¯å¤„äºçš„çŠ¶æ€ï¼ˆè‰æ¡ˆï¼Œç­‰å¾…å®¡æ ¸ï¼Œå·²å‘å¸ƒï¼‰ä¹‹ä¸€ï¼Œç”¨æˆ·å¯å¯¹ `Post` å®ä¾‹è°ƒç”¨ç›¸åº”çš„æ–¹æ³•ä»¥æ”¹å˜å…¶çŠ¶æ€ã€‚

### å®šä¹‰ `Post` å¹¶æ–°å»ºä¸€ä¸ªè‰æ¡ˆçŠ¶æ€çš„å®ä¾‹

å®šä¹‰ç§æœ‰ trait `State`ï¼Œä»¥åŠåšæ–‡ç»“æ„ä½“ `Post`ï¼š

```rust
trait State {}

pub struct Post {
    state: Option<Box<dyn State>>,
    content: String,
}
```

å†åˆ›å»º 3 ä¸ªçŠ¶æ€ç±»ï¼Œå¹¶åˆ†åˆ«å®ç° `State`ï¼š

```rust
struct Draft {}

impl State for Draft {}

struct PendingReview {}

impl State for PendingReview {}

struct Published {}

impl State for Published {}
```

ç°åœ¨ï¼Œä¸º `Post` å®ç° `new()`ï¼Œæ–°å»ºä¸€ä¸ª `Draft` ä»¥ç¡®ä¿ä»»ä½•åšæ–‡éƒ½ä»è‰ç¨¿å¼€å§‹ï¼š

```rust
impl Post {
    pub fn new() -> Post {
        Post {
            state: Some(Box::new(Draft {})),
            content: String::new(),
        }
    }
}
```

### å­˜æ”¾åšæ–‡å†…å®¹çš„æ–‡æœ¬

ä¸º `Post` å®ç° `add_text()`ï¼š

```rust
pub fn add_text(&mut self, text: &str) {
	self.content.push_str(text);
}
```

è¿™ä¸ªæ–¹æ³•ä¸æ˜¯çŠ¶æ€æ¨¡å¼çš„ä¸€éƒ¨åˆ†ï¼Œè€Œæ˜¯åŠŸèƒ½æ€§æ–¹æ³•ã€‚

### ç¡®ä¿åšæ–‡è‰æ¡ˆçš„å†…å®¹æ˜¯ç©ºçš„

æˆå‘˜å˜é‡ `content` æ˜¯ç§æœ‰çš„ï¼Œå®ç° `content()` ä»¥è¿›è¡Œè®¿é—®ï¼š

```rust
pub fn content(&self) -> &str {
	""
}
```

è®¾è®¡ä¸Šå¸Œæœ›ä»…åœ¨åšæ–‡è¿‡å®¡åæ‰æ˜¾ç¤ºå…¶å†…å®¹ï¼Œå› æ­¤å³ä½¿è°ƒç”¨äº† `add_text()`ï¼Œè‰ç¨¿ä¸­çš„å†…å®¹ä¹Ÿä¸è¯¥è¢«è¿”å›ã€‚æ­¤å¤„ç›´æ¥ç¡¬è¿”å›ä¸€ä¸ªç©ºä¸²ï¼Œç¨åå†è¡¥å……çœŸæ­£çš„å®ç°ã€‚

### è¯·æ±‚å®¡æ ¸åšæ–‡æ¥æ”¹å˜å…¶çŠ¶æ€

ä¸º `State` trait å¢åŠ  `request_review()`ï¼š

```rust
trait State {
    fn request_review(self: Box<Self>) -> Box<dyn State>;
}
```

ä¸åŒäº `self` / `&self` / `&mut self`ï¼Œè¿™é‡Œä½¿ç”¨äº† `self: Box<Self>`ï¼Œæ„å‘³ç€ `request_review()` åªèƒ½åœ¨æŒæœ‰è¿™ä¸ªç±»å‹çš„Â `Box`Â ä¸Šè¢«è°ƒç”¨ã€‚`self` è·å–äº†Â `Box<Self>`Â çš„æ‰€æœ‰æƒï¼Œä½¿æ—§çš„çŠ¶æ€å¤±æ•ˆï¼Œä»¥ä¾¿Â `Post`Â è½¬æ¢åˆ°æ–°çŠ¶æ€ã€‚

ä¸º `Post` å®ç° `request_review()`ï¼š

```rust
impl Post {
	// ...
	
	pub fn request_review(&mut self) {
		if let Some(s) = self.state.take() {
			self.state = Some(s.request_review())
		}
	}
}
```

`request_review()` è·å– `Post` çš„å¯å˜å¼•ç”¨ï¼Œå¹¶åœ¨å…¶å½“å‰çŠ¶æ€ä¸‹è°ƒç”¨å†…éƒ¨çš„ `request_review()`ï¼Œåè€…æ¶ˆè´¹å½“å‰çŠ¶æ€å¹¶è¿”å›ä¸€ä¸ªæ–°çŠ¶æ€ã€‚ç”¨ `if let` è§£æ„ `take()` çš„è¿”å›å€¼ï¼Œåè€…è·å–äº†æ—§çŠ¶æ€çš„æ‰€æœ‰æƒï¼Œä»¥ä½¿å…¶å¤±æ•ˆã€‚

å†ä¸º `Draft` å’Œ `PendingReview` å®ç° `request_review()`ï¼š

```rust
struct Draft {}

impl State for Draft {
    fn request_review(self: Box<Self>) -> Box<dyn State> {
        Box::new(PendingReview {})
    }
}

struct PendingReview {}

impl State for PendingReview {
    fn request_review(self: Box<Self>) -> Box<dyn State> {
        self
    }
}
```

åœ¨ `Draft` çŠ¶æ€ç”³è¯·å®¡æ ¸æ—¶ï¼Œè¿”å›ä¸€ä¸ªè£…ç®±çš„ `PendingReview` å®ä¾‹ï¼Œè€Œå¦‚æœç»§ç»­ç”³è¯·å®¡æ ¸ï¼Œå°†è¿”å›è‡ªèº«ï¼Œå› ä¸ºæ­¤æ—¶å·²ç»å¤„äºç­‰å¾…å®¡æ ¸çš„çŠ¶æ€ã€‚

æ— è®ºç›®å‰å¤„äºå“ªä¸ªçŠ¶æ€ï¼Œéƒ½ä¸å½±å“ `Post` ä¸­ `request_review()` çš„å®ç°ï¼Œå› ä¸ºæ¯ä¸ªçŠ¶æ€åªéœ€è´Ÿè´£è‡ªèº«çš„è§„åˆ™ã€‚

### å¢åŠ æ”¹å˜ `content` è¡Œä¸ºçš„ `approve` æ–¹æ³•

ä¸º `State` trait å¢åŠ  `approve()`ï¼š

```rust
trait State {
    fn request_review(self: Box<Self>) -> Box<dyn State>;
    fn approve(self: Box<Self>) -> Box<dyn State>;
}
```

ä¸º `Post` å®ç° `approve()`ï¼š

```rust
impl Post {
	// ...
	
	pub fn approve(&mut self) {
		if let Some(s) = self.state.take() {
			self.state = Some(s.approve())
		}
	}
}
```

éƒ½éå¸¸ç±»ä¼¼äº `request_review()` çš„å®ç°ï¼Œæ¯•ç«Ÿéƒ½æ˜¯çŠ¶æ€çš„è½¬æ¢ã€‚

å†ä¸º `PendingReview` å’Œ `Published` å®ç° `approve()`ï¼Œå½“ç„¶ï¼Œç”±äºä¿®æ”¹äº† `State` çš„å®šä¹‰ï¼Œ3 ç§çŠ¶æ€éƒ½éœ€è¦å®ç°è¿™ä¸¤ä¸ªæ–¹æ³•ï¼š

```rust
struct Draft {}

impl State for Draft {
    fn request_review(self: Box<Self>) -> Box<dyn State> {
        Box::new(PendingReview {})
    }
    
    fn approve(self: Box<Self>) -> Box<dyn State> {
        self
    }
}

struct PendingReview {}

impl State for PendingReview {
    fn request_review(self: Box<Self>) -> Box<dyn State> {
        self
    }
    
    fn approve(self: Box<Self>) -> Box<dyn State> {
        Box::new(Published {})
    }
}

struct Published {}

impl State for Published {
    fn request_review(self: Box<Self>) -> Box<dyn State> {
        self
    }
    
    fn approve(self: Box<Self>) -> Box<dyn State> {
        self
    }
}
```

ç°åœ¨ï¼Œå°† `content()` çš„ä¼ªå®ç°æ›¿æ¢ä¸ºçœŸæ­£çš„å®ç°ï¼š

```rust
impl Post {
	pub fn content(&self) -> &str {
        self.state.as_ref().unwrap().content(self) // error
    }
}
```

æ— æ³•è¿‡ç¼–ï¼š

```text
error[E0599]: no method named `content` found for reference `&Box<dyn State>` in the current scope
  --> src\lib.rs:18:38
   |
18 |         self.state.as_ref().unwrap().content(self)
   |                                      ^^^^^^^ method not found in `&Box<dyn State>`
```

è¿™é‡Œçš„ `unwrap()` ä¸€å®šä¼šè¿”å› `Some` è€Œé `None`ï¼Œå› ä¸ºå®ç°æ—¶ `Post` çš„æ‰€æœ‰æ–¹æ³•éƒ½ç¡®ä¿åœ¨è¿”å›æ—¶çŠ¶æ€å°†æœ‰ä¸€ä¸ª `Some` å€¼ï¼Œä½†æ˜¯ç¼–è¯‘å™¨æ— ä»çŸ¥æ™“è¿™ä¸ªå®é™…ä¸Šå®‰å…¨çš„å®ç°ç»†èŠ‚ï¼Œå®ƒè®¤ä¸ºå¯¹ä¸€ä¸ª `None` è°ƒç”¨ `content()` æ˜¯å±é™©çš„ï¼Œå±äºâ€œæˆ‘ä»¬æ¯”ç¼–è¯‘å™¨çŸ¥é“æ›´å¤šæƒ…å†µâ€ã€‚

è¦ä¿®å¤è¿™ä¸ªæƒ…å†µï¼Œå¯ä»¥ä¸º `State` å¢åŠ ä¸€ä¸ªæ–¹æ³• `content()`ï¼Œå¹¶é»˜è®¤å®ç°è¿”å›ä¸€ä¸ªç©ºä¸²ï¼š

```rust
trait State {
	// ...
	
	fn content<'a>(&self, post: &'a Post) -> &'a str {
        ""
    }
}
```

ç„¶ååœ¨ `Published` ä¸­é‡å†™ `content()`ï¼š

```rust
impl State for Published {
	// ...
	
    fn content<'a>(&self, post: &'a Post) -> &'a str {
        &post.content
    }
}
```

ç°åœ¨ï¼Œæ‰€æœ‰ä»£ç éƒ½èƒ½å¦‚æœŸå·¥ä½œäº†ã€‚

### çŠ¶æ€æ¨¡å¼çš„æƒè¡¡å–èˆ

çŠ¶æ€æ¨¡å¼çš„ä¼˜ç¼ºç‚¹ï¼š

- ä¼˜ç‚¹ï¼šé€»è¾‘ç»„ç»‡æ¸…æ™°ï¼Œå¦‚è¦æŸ¥æ‰¾æ‰€æœ‰å·²å‘å¸ƒåšæ–‡çš„è¡Œä¸ºï¼Œåªéœ€æŸ¥çœ‹ Published çš„å®ç°ã€‚
- ç¼ºç‚¹ï¼šä¸€äº›çŠ¶æ€ä¹‹é—´ç›¸äº’è”ç³»ï¼Œå¦‚éœ€åœ¨ `PendingReview` ä¸ `Published` ä¹‹é—´å¢åŠ ä¸€ä¸ª `Scheduled` çŠ¶æ€ï¼Œå¯èƒ½è¦æ”¹å˜ä¸¤ä¸ªçŠ¶æ€ã€‚

#### å°†çŠ¶æ€å’Œè¡Œä¸ºç¼–ç ä¸ºç±»å‹

ä»¥ä¸Šæ˜¯å®Œå…¨å°†å…¶ä»–é¢å‘å¯¹è±¡è¯­è¨€çš„è®¾è®¡æ¨¡å¼ç…§æ¬è¿› Rust çš„å®ç°ï¼Œä¸‹é¢åæ€å…¶ä¸­çš„ä¸€äº›è®¾è®¡ä»¥ä½¿å…¶æ›´ Rustyã€‚

æ­¤å‰ï¼Œè¯•å›¾æŸ¥çœ‹ `Draft` çŠ¶æ€çš„åšæ–‡å†…å®¹å°†å¾—åˆ°ä¸€ä¸ªç©ºä¸²ï¼š

```rust
trait State {
	// ...
	
    fn content<'a>(&self, post: &'a Post) -> &'a str {
        ""
    }
}

impl State for Draft {
	// æœªé‡å†™ content()
}
```

ç°åœ¨ä¿®æ”¹å®ç°ï¼Œåœ¨ç¼–è¯‘æœŸå°±ç¦æ­¢è·å– `Draft` å†…å®¹çš„å°è¯•ã€‚

æ–°å¢ä¸€ä¸ªç»“æ„ä½“ `Draft`ï¼Œæ ¹æœ¬ä¸å®ç° `content()`ï¼š

```rust
pub struct Draft {
    content: String,
}

impl Draft {
    pub fn add_text(&mut self, text: &str) {
        self.content.push_str(text);
    }
}
```

å†ä¿®æ”¹ `impl Post` å—ä¸­ `new()` å’Œ `content()` çš„å®ç°ï¼š

```rust
impl Post {
    pub fn new() -> Draft {
        Draft {
            content: String::new(),
        }
    }
    
    pub fn content(&self) -> &str {
        &self.content
    }
    
    // ...
}
```

#### å®ç°çŠ¶æ€è½¬ç§»ä¸ºä¸åŒç±»å‹çš„è½¬æ¢

å®ç° `PendingReview`ï¼Œ`PendingReview::approve()` å°†æ¶ˆè´¹å…¶è‡ªèº«å¹¶è¿”å› `Post` å®ä¾‹ï¼š

```rust
pub struct PendingReview {
    content: String,
}

impl PendingReview {
    pub fn approve(self) -> Post {
        Post {
            content: self.content,
        }
    }
}
```

åŒç†ï¼Œå®ç° `Draft::request_review()`ï¼Œæ¶ˆè´¹å…¶è‡ªèº«å¹¶è¿”å› `PendingReview` å®ä¾‹ï¼š

```rust
impl Draft {
	// ...
	
	pub fn request_review(self) -> PendingReview {
	    PendingReview {
	        content: self.content,
	    }
	}
}
```

è¿˜éœ€ä¿®æ”¹ `main()` ä»¥é€‚åº”ä¸Šè¿°ä¿®æ”¹ï¼š

```rust
fn main() {
    let mut post = Post::new();
    post.add_text("I ate a salad for lunch today");
    let post = post.request_review();
    let post = post.approve();
    assert_eq!("I ate a salad for lunch today", post.content());
}
```

ğŸ‘‰ [[16 æ¨¡å¼ä¸æ¨¡å¼åŒ¹é…]]