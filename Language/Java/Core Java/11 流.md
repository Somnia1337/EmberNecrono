ç›¸æ¯”é›†åˆï¼Œæµæä¾›äº†ä¸€ç§å¯ä»¥åœ¨æ›´é«˜çš„æ¦‚å¿µçº§åˆ«ä¸ŠæŒ‡å®šè®¡ç®—ä»»åŠ¡çš„æ•°æ®è§†å›¾ã€‚ä½¿ç”¨æµæ—¶ï¼Œåªéœ€æŒ‡å®šéœ€è¦å®Œæˆçš„ä»»åŠ¡ï¼Œè€Œæ— éœ€æŒ‡å®šå¦‚ä½•å®ç°ã€‚

ä¾‹å¦‚ï¼Œè¦è®¡ç®—æŸå±æ€§çš„å¹³å‡å€¼ï¼Œå¯ä»¥æŒ‡å®šæ•°æ®æºä¸ç›®æ ‡å±æ€§ï¼Œç„¶åç”±æµåº“ä¼˜åŒ–è®¡ç®—ï¼ˆä½¿ç”¨å¤šçº¿ç¨‹ç­‰ï¼‰ã€‚

## 1. ä»è¿­ä»£åˆ°æµ

```java
// ä»è¿­ä»£åˆ°æµ
// åˆ›å»º List
List<String> words = new ArrayList<>();

// è¿­ä»£å†™æ³•
int count = 0;
for (String w : words) {
	if (w.length() > 10) count++;
}

// æµå†™æ³•
long count = words.stream().filter(w -> w.length() > 10).count();
```

`Collection` æ¥å£çš„ **`stream()`**ï¼šå°†é›†åˆè½¬æ¢ä¸ºæµã€‚

**`filter()`**ï¼šç”Ÿæˆä¸€ä¸ªæ–°æµï¼ŒåŒ…å«æ»¡è¶³æŒ‡å®šæ¡ä»¶çš„å…ƒç´ ã€‚

**`count()`**ï¼šè¿”å›æµä¸­çš„å…ƒç´ æ•°é‡ã€‚

æµå†™æ³•åªéœ€çœ‹æ–¹æ³•åå°±èƒ½æ˜ç™½ä»£ç çš„ä½œç”¨ï¼Œå¯è¯»æ€§æ›´å¥½ã€‚

å°† `.stream()` æ”¹ä¸º `.parallelStream()` æˆ–å¯¹å·²æœ‰æµè°ƒç”¨ `.parallel()` å¯ä»¥æŒ‡å®šä»¥å¹¶è¡Œæ–¹å¼å¤„ç†ã€‚

æµéµå¾ªâ€œåšä»€ä¹ˆè€Œéæ€ä¹ˆåšâ€çš„åŸåˆ™ï¼Œåªè¦ç»“æœæ­£ç¡®ï¼Œæ“ä½œçš„å®ç°ä¸é¡ºåºæ˜¯ä»»æ„çš„ï¼Œèƒ½å¤Ÿä¼˜åŒ–è®¡ç®—ã€‚

æµä¸é›†åˆç±»ä¼¼ï¼Œéƒ½å¯ä»¥è·å–ä¸è½¬æ¢æ•°æ®ï¼Œå®ƒä»¬çš„åŒºåˆ«ï¼š

- æµä¸å­˜å‚¨å…ƒç´ ï¼Œå…¶æ‰€æ“ä½œçš„å¯¹è±¡å¯ä»¥ä½äºé›†åˆä¸­ï¼Œä¹Ÿå¯ä»¥æŒ‰éœ€ç”Ÿæˆã€‚
- æµä¸ä¼šä¿®æ”¹æºæ•°æ®ï¼Œä¾‹å¦‚ï¼Œ`filter` ä¸ä¼šä»æºä¸­åˆ é™¤å…ƒç´ ï¼Œè€Œæ˜¯ç”Ÿæˆä¸€ä¸ªæ–°çš„ã€åªåŒ…å«æ»¡è¶³æ¡ä»¶çš„å…ƒç´ çš„æµã€‚
- æµçš„æ“ä½œå°½å¯èƒ½æƒ°æ€§æ‰§è¡Œï¼ˆç›´åˆ°éœ€è¦è®¡ç®—ç»“æœæ—¶æ‰æ‰§è¡Œè®¡ç®—ï¼‰ï¼Œä¾‹å¦‚ï¼Œè¦æ±‚æŸ¥æ‰¾å‰ 5 ä¸ªç¬¦åˆè¦æ±‚çš„å•è¯æ—¶ï¼Œæµå°†åœ¨æ‰¾åˆ°ç¬¬ 5 ä¸ªç›®æ ‡åç«‹å³åœæ­¢è®¡ç®—ã€‚

## 2. æµçš„åˆ›å»º

**é™æ€æ–¹æ³• `Stream::of`**ï¼šå°†æ•°ç»„è½¬æ¢ä¸ºæµã€‚

```java
Stream<String> words = Stream.of(contents.split("\\PL+"));

// å…¶å‚æ•°ä¸ªæ•°å¯å˜, å¯ä»¥åˆ›å»ºæœ‰ä»»æ„æ•°é‡å¼•å…ƒçš„æµ
Stream<String> song = Stream.of("gently", "down", "the", "stream");
```

**é™æ€æ–¹æ³• `Arrays::stream`**ï¼šå°†æ•°ç»„è½¬æ¢ä¸ºæµï¼Œä¸”å¯æŒ‡å®šåªä½¿ç”¨ä¸€ä¸ªå­æ•°ç»„ã€‚

```java
Stream<String> someWords = Arrays.stream(contents, 0, 10);
```

**é™æ€æ–¹æ³• `Stream::empty`**ï¼šåˆ›å»ºä¸å«ä»»ä½•å…ƒç´ çš„æµã€‚

```java
Stream<String> silence = Stream.empty();
```

`Stream` æ¥å£æœ‰ä¸¤ä¸ªç”¨äºåˆ›å»ºæ— é™æµçš„é™æ€æ–¹æ³•ï¼š

- **`generate()`**ï¼šæ¥æ”¶ä¸€ä¸ªä¸å«ä»»ä½•å¼•å…ƒçš„æ–¹æ³•ï¼ˆæŠ€æœ¯ä¸Šï¼Œæ˜¯ä¸€ä¸ª `Supplier<T>` æ¥å£å¯¹è±¡ï¼‰ï¼Œé€šå¸¸åœ¨éœ€è¦ä¸€ä¸ªæµç±»å‹çš„å€¼æ—¶è°ƒç”¨ã€‚

```java
Stream<String> echos = Stream.generate(() -> "Echo");
```

```java
// ç”Ÿæˆä¸€ä¸ªéšæœºæ•°çš„æµ
Stream<Double> randoms = Stream.generate(Math::random);
```

- **`iterate()`**ï¼šæ¥æ”¶ä¸€ä¸ªâ€œç§å­â€å€¼ä¸ä¸€ä¸ªæ–¹æ³•ï¼ˆæŠ€æœ¯ä¸Šï¼Œæ˜¯ä¸€ä¸ª `UnaryOperator<T>` æ¥å£å¯¹è±¡ï¼‰ï¼Œè¿­ä»£å¼åœ°å¯¹å‰ä¸€æ¬¡çš„ç»“æœå†æ¬¡è°ƒç”¨è¯¥æ–¹æ³•ã€‚

```java
Stream<BigInteger> integers = Stream.iterate(BigInteger.ZERO, n -> n.add(BigInteger.ONE));
```

åœ¨ç”Ÿæˆçš„æµä¸­ï¼Œç¬¬ 1 ä¸ªå…ƒç´ ä¸ºç§å­ `BigInteger.ZERO`ï¼Œç¬¬ 2 ä¸ªä¸º `f(BigInteger.ZERO)`ï¼Œç¬¬ 3 ä¸ªä¸º `f(f(BigInteger.ZERO))`ï¼Œä»¥æ­¤ç±»æ¨ã€‚

**è°“è¯**(predicate)ï¼šå‡½æ•°å¼æ¥å£ `Predicate`ï¼ˆè§ \[4 2. 3) å‡½æ•°å¼æ¥å£]ï¼‰ä¸å†…éƒ¨ç±» çš„å®ä¾‹ï¼Œä¸€ä¸ªè¿”å› `true` æˆ– `false` çš„è¡¨è¾¾å¼ã€‚

è°“è¯å¯ä»¥æè¿° `iterate` çš„è¿­ä»£æ“ä½œåº”ä½•æ—¶ç»“æŸï¼Œç”¨ä»¥ç”Ÿæˆæœ‰é™æµã€‚

```java
BigInteger aMillion = new BigInteger("1,000,000");
Predicate<BigInteger> lessThanAMillion = n -> n.compareTo(aMillion) < 0; // è°“è¯
Stream<BigInteger> integers = Stream.iterate(BigInteger.ZERO, filter(lessThanAMillion), n -> n.add(BigInteger.ONE));

// ç”¨å†…åµŒ lambda æ”¹å†™ä¸º
Stream<BigInteger> integers = Stream.iterate(BigInteger.ZERO, n -> n.compareTo(aMillion) < 0, n -> n.add(BigInteger.ONE));
```

å¦‚æœæŸæ¬¡è¿­ä»£çš„ç»“æœæ²¡æœ‰é€šè¿‡è°“è¯çš„æ£€æŸ¥æ¡ä»¶ï¼Œæµçš„ç”Ÿæˆå°†ç»ˆæ­¢ã€‚

**æ–¹æ³•Stream.ofNullable**ï¼šç”±æŒ‡å®šå¯¹è±¡ç”Ÿæˆä¸€ä¸ªçŸ­æµï¼Œå¦‚æœè¯¥å¯¹è±¡ä¸ºnullï¼Œæµçš„é•¿åº¦ä¸º0ï¼Œå¦åˆ™ä¸º1ï¼ˆåªåŒ…å«è¯¥å¯¹è±¡ï¼‰ï¼Œå®ƒå¸¸ä¸æ–¹æ³•flatMapç»“åˆï¼ˆè§\[11 7. 7) å°†Optionalè½¬æ¢ä¸ºæµ]ï¼‰ã€‚

**æ–¹æ³•toList**ï¼šå°†æµä¸­çš„å…ƒç´ æ”¶é›†åˆ°ä¸€ä¸ªListä¸­ã€‚ä¸countç›¸åŒï¼ŒtoListå°†åœ¨æµçš„ç”Ÿæˆç»ˆæ­¢æ—¶æ‰§è¡Œã€‚

**æ–¹æ³•limit**ï¼šå°†æµçš„æœ€å¤§é•¿åº¦é™åˆ¶ä¸ºæŒ‡å®šæ•´æ•°ï¼Œè¶…å‡ºæ—¶ï¼Œæµçš„ç”Ÿæˆå°†ç»ˆæ­¢ã€‚

```java
/*limitçš„ä½¿ç”¨*/
Stream<Double> randoms = Stream.generate(Math::random).limit(10);
```

å°†å…¶ä»–ç±»å‹çš„å¯¹è±¡è½¬æ¢ä¸ºæµï¼š

```java
//éé›†åˆçš„Iterableå¯¹è±¡
StreamSupport.stream(iterable.spliterator(), false);

//Iteratorå¯¹è±¡
StreamSupport.stream(Spliterators.spliteratorUnknownSize(iterator, Spliterator.ORDERED), false);
```

æµæ“ä½œåˆ†ä¸ºä¸­é—´æ“ä½œä¸ç»ˆæ­¢æ“ä½œï¼š

- **ä¸­é—´æ“ä½œ**ï¼šè¿”å›ä¸€ä¸ªæµçš„æ“ä½œï¼Œä¾‹å¦‚ç­›é€‰ã€æ˜ å°„ã€æ’åºï¼Œå¯ä»¥è¿æ¥å½¢æˆä¸€ä¸ªâ€œæµæ°´çº¿â€ï¼Œä½†ä¸ä¼šç”Ÿæˆç»“æœã€‚
- **ç»ˆæ­¢æ“ä½œ**ï¼šè¿”å›ä¸€ä¸ªéæµçš„æ“ä½œï¼Œä¾‹å¦‚forEachã€reduceã€collectï¼Œå¯ä»¥è§¦å‘ä¸­é—´æ“ä½œçš„æ‰§è¡Œï¼Œå¹¶ç”Ÿæˆç»“æœã€‚

è¿˜åˆ†ä¸ºå¹²æ¶‰æ“ä½œä¸éå¹²æ¶‰æ“ä½œï¼š

- **å¹²æ¶‰æ“ä½œ**(intermediate operation)ï¼šåœ¨â€œæµæ°´çº¿â€ä¸­ä¿®æ”¹æµä¸­çš„å…ƒç´ æˆ–äº§ç”Ÿå‰¯ä½œç”¨çš„ä¸­é—´æ“ä½œï¼ŒåŒ…æ‹¬filterã€distinctã€sortedã€mapã€flatMapç­‰ï¼Œå®ƒä»¬å¯ä»¥ä¿®æ”¹æµçš„å…ƒç´ æˆ–ç»“æ„ï¼Œæˆ–è€…äº§ç”Ÿå‰¯ä½œç”¨ï¼Œä¾‹å¦‚ä¿®æ”¹å…¨å±€å˜é‡ã€æ‰“å°æ—¥å¿—ç­‰ã€‚
- **éå¹²æ¶‰æ“ä½œ**(non-interference operation)ï¼šä¸ä¿®æ”¹æµçš„å…ƒç´ æˆ–ç»“æ„ã€è€Œåªæ˜¯ç”Ÿæˆä¸€ä¸ªæ–°æµçš„æ“ä½œï¼ŒåŒ…æ‹¬limitã€skipã€forEachã€reduceã€collectç­‰ç»ˆæ­¢æ“ä½œä»¥åŠpeekç­‰ä¸­é—´æ“ä½œã€‚

åº”é¿å…åœ¨åŒä¸€ä¸ªâ€œæµæ°´çº¿â€ä¸­ä½¿ç”¨å¤šä¸ªå¹²æ¶‰æ“ä½œï¼Œå› ä¸ºè¿™å°†å¯¼è‡´éš¾ä»¥ç†è§£å’Œè°ƒè¯•çš„è¡Œä¸ºã€‚ä½¿ç”¨å¹²æ¶‰æ“ä½œæ—¶ï¼Œåº”å•ç‹¬è°ƒç”¨ï¼Œå¹¶å°†ç»“æœä¼ é€’ç»™ä¸‹ä¸€ä¸ªâ€œæµæ°´çº¿â€ã€‚ç›¸åï¼Œåº”å°½å¯èƒ½é€šè¿‡é“¾å¼è°ƒç”¨å°†å¤šä¸ªéå¹²æ¶‰æ“ä½œç»„åˆåœ¨ä¸€èµ·ï¼Œä»¥æé«˜ä»£ç çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

```java
/*æµæ“ä½œçš„ä½¿ç”¨*/
List<String> wordList = ...;
Stream<String> words = wordList.stream();

//ä¸æ¨èçš„ä»£ç ï¼Œä¸è¿‡å¯ä»¥æ­£å¸¸è¿è¡Œ
wordList.add("END");
long n = words.distinct().count();

//é”™è¯¯çš„ä»£ç 
words.forEach(s -> {} if (s.length() < 12) wordList.remove(s); {});
```

```java
/*æµçš„ä½¿ç”¨*/
import java.io.*;
import java.math.*;
import java.nio.file.*;
import java.util.*;
import java.util.regex.Pattern;
import java.util.stream.*;

public class CreatingStreams
{
	public static <T> void show(String title, Stream<T> stream)
	{
		final int SIZE = 10;
		List<T> firstElements = stream
			.limit(SIZE + 1)
			.toList();
		System.out.print(title + ": ");
		for (int i = 0; i < firstElements.size(); i++)
		{
			if (i > 0) System.out.print(", ");
			if (i < SIZE) System.out.print(firstElements.get(i));
			else System.out.print("...");
		}
		System.out.println();
	}
	
	public static void main(String[] args) throws IOException
	{
		Path path = Path.of("D:\\NOTICE.txt");
		var contents = Files.readString(path);
		
		Stream<String> words = Stream.of(contents.split("\\PL+"));
		show("words", words);
		Stream<String> song = Stream.of("a", "an", "and", "the");
		show("song", song);
		Stream<String> silence = Stream.empty();
		show("silence", silence);
		
		Stream<String> echos = Stream.generate(() -> "Echo");
		show("echos", echos);
		
		Stream<Double> randoms = Stream.generate(Math::random);
		show("randoms", randoms);
		
		Stream<BigInteger> integers = Stream.iterate(BigInteger.ONE,
			n -> n.add(BigInteger.ONE));
		show("integers", integers);
		
		Stream<String> greetings = "Hello\nGuten Tag\nBonjour".lines();
		show("greetings", greetings);
		
		Stream<String> wordsAnotherWay = Pattern.compile("\\PL+").splitAsStream(contents);
		show("wordsAnotherWay", wordsAnotherWay);
		
		try (Stream<String> lines = Files.lines(path))
		{
			show("lines", lines);
		}
		
		Iterable<Path> iterable = FileSystems.getDefault().getRootDirectories();
		Stream<Path> rootDirectories = StreamSupport.stream(iterable.spliterator(), false);
		show("rootDirectories", rootDirectories);
		
		Iterator<Path> iterator = Path.of("D:\\NOTICE.txt").iterator();
		Stream<Path> pathComponents = StreamSupport.stream(Spliterators.spliteratorUnknownSize(iterator, Spliterator.ORDERED), false);
		show("pathComponents", pathComponents);
	}
}
```

## 3. mapä¸flatMap

**æ–¹æ³•map**ï¼šæŒ‰æŒ‡å®šè½¬æ¢é€»è¾‘è½¬æ¢æ‰€æœ‰æµå…ƒç´ ï¼Œç”Ÿæˆä¸€ä¸ªæ–°æµã€‚

```java
/*mapçš„ä½¿ç”¨*/
Stream<String> lowercaseWords = words.stream().map(String::toLowerCase);

//ç”¨lambdaæ”¹å†™ä¸º
Stream<String> lowercaseWords = words.stream().map(s -> s.toLowerCase());
```

å‡å®šæ–¹æ³•codePointsï¼Œå®ƒè¿”å›ä¸€ä¸ªStringæµï¼ˆStream\<String>ï¼‰ï¼ŒåŒ…å«æŒ‡å®šå­—ç¬¦ä¸²çš„æ‰€æœ‰çš„Unicodeç ç‚¹ï¼Œä¾‹å¦‚è°ƒç”¨`codePoints("HelloğŸŒ")`å°†å¾—åˆ°æµ`["H", "e", "l", "l", "o", "ğŸŒ"]`ã€‚

å¦‚æœè°ƒç”¨`.map(codePoints)`ï¼š

```java
Stream<Stream<String>> result = words.stream().map(w -> codePoints(w));
```

å°†å¾—åˆ°ä¸€ä¸ªåµŒå¥—æµï¼ˆ`Stream<Stream<T>>`ï¼Œä¾‹å¦‚`[...["h", "i"], ["m", "e"]...]`ï¼‰ã€‚

**æ–¹æ³•flatMap**ï¼šç±»ä¼¼äºmapï¼Œä¸è¿‡æœ€åå°†å¤šä¸ªæµåˆå¹¶ä¸ºä¸€ä¸ªã€‚

```java
Stream<String> flatResult = words.stream().flatMap(w -> codePoints(w));
```

å®é™…ä¸Šï¼ŒStringç±»ä¸­æœ‰æ–¹æ³•codePointsï¼Œå®ƒè¿”å›ä¸€ä¸ªIntStreamï¼Œè°ƒç”¨`"HelloğŸŒ".codePoints()`å°†è¿”å›IntStream`[72, 101, 108, 108, 111, 32, 127760]`ã€‚

IntStreamä¸Stream\<Integer>ç•¥æœ‰ä¸åŒï¼š

- IntStreamä¸º**åŸºæœ¬ç±»å‹æµ**ï¼Œæ˜¯ä¸€ç§ç‰¹æ®Šç±»å‹çš„æµï¼Œä¸“ç”¨äºå¤„ç†åŸºæœ¬ç±»å‹å…ƒç´ ã€‚å®ƒæä¾›ä¸€ç»„ä¸“é—¨å¤„ç†åŸºæœ¬ç±»å‹å…ƒç´ çš„æ“ä½œæ–¹æ³•ï¼Œä¾‹å¦‚æ±‚å’Œã€å¹³å‡å€¼ã€æœ€å¤§å€¼ã€æœ€å°å€¼ã€‚
- Stream\<Integer>ä¸º**åŒ…è£…ç±»å‹æµ**ï¼Œæ˜¯é€šç”¨çš„æ³›å‹æµï¼Œå¯ä»¥å¤„ç†ä»»ä½•ç±»å‹çš„å…ƒç´ ã€‚å®ƒæä¾›ä¸€ç»„å¯ä»¥å¤„ç†ä»»ä½•ç±»å‹å…ƒç´ çš„æ“ä½œæ–¹æ³•ï¼Œä¾‹å¦‚è¿‡æ»¤ã€æ˜ å°„ã€æ’åºã€‚
- åŸºæœ¬ç±»å‹æµåœ¨å¤„ç†åŸºæœ¬ç±»å‹å…ƒç´ æ—¶æ¯”åŒ…è£…ç±»å‹æµæ›´é«˜æ•ˆï¼Œè€ŒåŒ…è£…ç±»å‹æµé€‚ç”¨èŒƒå›´æ›´å¹¿ã€‚

**æ–¹æ³•mapTo(Int|Long|Double)**ï¼šå°†åŒ…è£…ç±»å‹æµè½¬æ¢ä¸ºåŸºæœ¬ç±»å‹æµã€‚

```java
/*åŸºæœ¬ç±»å‹æµä¸åŒ…è£…ç±»å‹æµçš„ä½¿ç”¨*/
//åŸºæœ¬ç±»å‹æµ
IntStream intStream = IntStream.of(1, 2, 3, 4, 5);
int sum = intStream.sum();

//åŒ…è£…ç±»å‹æµ
Stream<Integer> integerStream = Stream.of(1, 2, 3, 4, 5);
int sum = integerStream.mapToInt(Integer::intValue).sum();
```

ä¾‹å¦‚ï¼Œå°†å­—ç¬¦ä¸²æµä¸­å…ƒç´ é•¿åº¦è½¬æ¢ä¸ºä¸€ä¸ªIntStreamï¼š

```java
Stream<String> words = ...;
IntStream lengths = words.mapToInt(String::length);
```

**æ–¹æ³•mapToObj**/**boxed**ï¼šå°†åŸºæœ¬ç±»å‹æµè½¬æ¢ä¸ºåŒ…è£…ç±»å‹æµã€‚

```java
/*ç”¨String.codePointsä¸mapToObjå®ç°è‡ªå®šä¹‰æ–¹æ³•codePoints*/
public static Stream<String> codePoints(String s)
{
	return s.codePoints().mapToObj(cp -> new String(new int [] { cp }, 0, 1));
}
```

```java
/*boxedçš„ä½¿ç”¨*/
Stream<Integer> integers = IntStream.range(0, 100)
									.boxed();
```

ä½¿ç”¨flatMapæ—¶éœ€è¦æä¾›ä¸€ä¸ªæ–¹æ³•ï¼Œä¸ºæ¯ä¸ªæµå…ƒç´ ç”Ÿæˆä¸€ä¸ªæ–°æµï¼Œè¿™æ ·åšæ•ˆç‡è¾ƒä½ã€‚

**æ–¹æ³•mapMulti**æä¾›äº†å¦ä¸€ç§é€‰æ‹©ï¼Œä¸å…¶äº§ç”Ÿç”±ç»“æœæ„æˆçš„æµï¼Œå®ƒå°†æ‰€æœ‰ç”Ÿæˆçš„ç»“æœé€šè¿‡è°ƒç”¨**æ–¹æ³•accept**ä¼ é€’ç»™ä¸€ä¸ª**æ”¶é›†å™¨**(collector/consumer)ï¼ˆä¸€ä¸ª**å‡½æ•°å¼æ¥å£Consumer**å¯¹è±¡ï¼‰ã€‚

```java
/*Consumerçš„å®šä¹‰*/
public interface Consumer<T>
{
	void accept(T, t);
}
```

è°ƒç”¨mapMultiæ—¶ï¼Œéœ€è¦æä¾›ä¸€ä¸ªåœ¨æµå…ƒç´ ä¸æ”¶é›†å™¨ä¸Šè°ƒç”¨çš„æ–¹æ³•ï¼Œå…¶è°ƒç”¨ç»“æœå°†ä¼ é€’ç»™æ”¶é›†å™¨ã€‚

```java
/*mapMultiçš„ä½¿ç”¨*/
Consumer<Integer> collector = ...;
List<Integer> numbers = List.of(1, 2, 3, 4, 5);
numbers.stream()
	   .mapMulti((num, collector) ->
			{
		        collector.accept(num * 2);
		        collector.accept(num * 3);
			})
	   .forEach(System.out::println);
```

## 4. å­æµä¸ç»„åˆæµ

**æ–¹æ³•limit**ï¼šé™åˆ¶æµçš„é•¿åº¦ï¼Œè°ƒç”¨`stream.limit(n)`å°†ç”Ÿæˆä¸€ä¸ªæ–°æµï¼ŒåªåŒ…å«æºæµçš„å‰`n`ä¸ªå…ƒç´ ã€‚

```java
/*limitçš„ä½¿ç”¨*/
Stream<Double> randoms = Stream.generate(Math::random).limit(100);
```

**æ–¹æ³•skip**ï¼šä»å¤´å¼€å§‹è·³è¿‡æµä¸­æŒ‡å®šæ•°é‡çš„å…ƒç´ ï¼Œè°ƒç”¨`stream.skip(n)`å°†ç”Ÿæˆä¸€ä¸ªæ–°æµï¼Œä¸åŒ…å«æºæµçš„å‰`n`ä¸ªå…ƒç´ ã€‚å¦‚æœæºæµä¸­å…ƒç´ æ•°é‡ä¸å¤§äº`n`ï¼Œåˆ™ç”Ÿæˆç©ºæµã€‚

```java
/*skipçš„ä½¿ç”¨*/
Stream<String> words = Stream.of(contents.split("\\PL+").skip(1));
```

**æ–¹æ³•takeWhile**ï¼šç±»ä¼¼äºfilterï¼ŒtakeWhileä¹Ÿæ¥æ”¶ä¸€ä¸ªè°“è¯ä½œä¸ºå‚æ•°ï¼Œç”¨äºè¿‡æ»¤æµå…ƒç´ ã€‚

filterä¸takeWhileçš„åŒºåˆ«ï¼š

- filterå¯¹æ‰€æœ‰æµå…ƒç´ è¿›è¡Œæ£€æŸ¥ï¼Œä¿ç•™æ»¡è¶³è°“è¯çš„å…ƒç´ ï¼Œå¹¶å°†å…¶ä¼ é€’ç»™ä¸‹ä¸€ä¸ªæ“ä½œã€‚
- takeWhileå¯¹æµå…ƒç´ ä¾æ¬¡æ£€æŸ¥ï¼Œä¸€æ—¦é‡åˆ°ä¸æ»¡è¶³è°“è¯çš„å…ƒç´ ï¼Œå°†åœæ­¢å¤„ç†ï¼Œå¹¶è¿”å›åœ¨å…¶ä¹‹å‰çš„æ‰€æœ‰å…ƒç´ ï¼ˆå³è¿ç»­çš„è‹¥å¹²ä¸ªæ»¡è¶³è°“è¯çš„å…ƒç´ ï¼‰ã€‚

```java
/*takeWhileçš„ä½¿ç”¨*/
Stream<String> str = Stream.of("1", "23", "54", "6", "Jack");
Stream<String> consecutiveIncreasingNumbers = str.takeWhile(
	s -> "0123456789".contains(s)); //["1", "23"]
```

**æ–¹æ³•dropWhile**ï¼šç±»ä¼¼äºtakeWhileï¼ŒdropWhileä¹Ÿå¯¹æµå…ƒç´ ä¾æ¬¡æ£€æŸ¥ï¼Œä¸è¿‡å®ƒåœ¨é‡åˆ°ä¸æ»¡è¶³è°“è¯çš„å…ƒç´ æ—¶å°†åœæ­¢æ£€æŸ¥å¹¶è¿”å›ä»è¯¥å…ƒç´ å¼€å§‹çš„æ‰€æœ‰å…ƒç´ ï¼ˆå³å»é™¤è¿ç»­çš„è‹¥å¹²ä¸ªæ»¡è¶³è°“è¯çš„å…ƒç´ ï¼‰ã€‚

```java
/*dropWhileçš„ä½¿ç”¨*/
Stream<String> str = Stream.of("1", "23", "54", "6", "Jack");
Stream<String> notConsecutiveIncreasingNumbers = str.dropWhile(
	s -> "0123456789".contains(s)); //["54", "6", "Jack"]
```

**é™æ€æ–¹æ³•Stream.concat**ï¼šæ‹¼æ¥ä¸¤ä¸ªæµã€‚

```java
/*Stream.concatçš„ä½¿ç”¨*/
Stream<String> combined = Stream.concat(Stream.of("Hello", " "),
										Stream.of("Java"));
```

ç¬¬ä¸€ä¸ªæµå‚æ•°ä¸èƒ½ä¸ºæ— é™æµï¼ˆè¯­æ³•ä¸Šåˆæ³•ï¼Œä½†å¦‚æœè¿™æ ·åšï¼Œç¬¬äºŒä¸ªæµå°†æ— æ³•å‚ä¸æ‹¼æ¥ï¼‰ã€‚

## 5. å…¶ä»–è½¬æ¢

**æ–¹æ³•distinct**ï¼šç”Ÿæˆä¸€ä¸ªæ–°æµï¼Œä»åŸæµä¸­å‰”é™¤é‡å¤å…ƒç´ ã€‚

```java
/*distinctçš„ä½¿ç”¨*/
Stream<String> uniqueWords = Stream.of("a", "b", "c", "a")
								   .distinct();
```

**æ–¹æ³•sorted**ï¼šç”Ÿæˆä¸€ä¸ªæ–°æµï¼Œå°†åŸæµçš„å…ƒç´ æ’åºã€‚

```java
/*sortedçš„ä½¿ç”¨*/
Stream<String> longestFirst = words.sorted(Comparator.comparing(String::length)
					   .reversed());
```

**æ–¹æ³•peek**ï¼šç”Ÿæˆä¸€ä¸ªæ–°æµï¼Œå…ƒç´ ä¸åŸæµç›¸åŒï¼Œä¸è¿‡æ¯æ¬¡è·å–å…ƒç´ æ—¶å¯¹å…¶è°ƒç”¨æŒ‡å®šå‡½æ•°ã€‚åœ¨è°ƒè¯•æ—¶å¾ˆæ–¹ä¾¿ã€‚

```java
/*peekçš„ä½¿ç”¨*/
Object[] powers = Stream.iterate(1.0, p -> p * 2)
						.peek(e -> System.out.println("Fetching" + e))
						.limit(20).toArray();
```

peekåœ¨å…¶åçš„ä¸­é—´æ“ä½œï¼ˆå¦‚mapã€filterï¼‰è¢«è°ƒç”¨æ—¶æ‰æ‰§è¡Œï¼Œä¸”ä¸ä¼šåœ¨ç»ˆæ­¢æ“ä½œä¹‹åæ‰§è¡Œã€‚

## 6. çº¦ç®€

**çº¦ç®€**(reduction)ï¼šå°†æµå…ƒç´ èšåˆä¸ºä¸€ä¸ªéæµå€¼ï¼Œä»¥ä¾¿åç»­ä½¿ç”¨ã€‚çº¦ç®€æ˜¯ä¸€ç§ç»ˆæ­¢æ“ä½œã€‚

ä¸Šæ–‡ä¸­çš„countå³ä¸ºä¸€ç§çº¦ç®€ï¼Œå…¶ä»–çº¦ç®€è¿˜æœ‰maxã€minç­‰ï¼Œå®ƒä»¬çš„è¿”å›å€¼ç±»å‹ä¸ºOptional\<T>ï¼ˆè§\[11 7. Optionalç±»å‹]ï¼‰ã€‚

```java
/*maxçš„ä½¿ç”¨*/
Optional<String> largest = words.max(String::compareToIgnoreCase);
System.out.println("largest: " + largest.orElse(""));
```

**æ–¹æ³•findFirst**ï¼šè¿”å›æµçš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œå¸¸ä¸filterç»„åˆä½¿ç”¨ã€‚

```java
/*findFirstçš„ä½¿ç”¨*/
Optional<String> firstStartsWithQ = words.filter(s -> s.startsWith("Q"))
										 .findFirst(); //é¦–ä¸ªä»¥Qå¼€å¤´çš„è¯
```

**æ–¹æ³•findAny**ï¼šç±»ä¼¼äºfindFirstï¼Œä¸è¿‡ä¸é™åˆ¶å…ƒç´ ä½ç½®ä¸ºç¬¬ä¸€ä¸ªã€‚

```java
/*findAnyçš„ä½¿ç”¨*/
Optional<String> anyStartsWithQ = words.parallel()
									   .filter(s -> s.startsWith("Q"))
									   .findAny(); //æŸä¸ªä»¥Qå¼€å¤´çš„è¯
```

åœ¨ä¸²è¡Œæµä¸­ï¼ŒfindAnyä¸findFirstéƒ½å°†è¿”å›ç¬¬ä¸€ä¸ªå…ƒç´ ï¼›ä½†åœ¨è¿™é‡Œï¼Œwordsè¢«è½¬æ¢ä¸ºå¹¶è¡Œæµå¤„ç†ï¼ŒfindAnyå°†è¿”å›æœ€å¿«å®Œæˆä»»åŠ¡çš„çº¿ç¨‹æ‰€å¤„ç†çš„å…ƒç´ ï¼Œä¸ä¸€å®šæ˜¯ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚

**æ–¹æ³•anyMatch**ï¼šæ£€æŸ¥æµä¸­æ˜¯å¦å­˜åœ¨æ»¡è¶³è°“è¯çš„å…ƒç´ ï¼Œè¿”å›å€¼ç±»å‹ä¸ºbooleanã€‚

```java
/*anyMatchçš„ä½¿ç”¨*/
boolean ifAnyWordStartsWithQ = words.parallel()
									.anyMatch(s -> s.startsWith("Q"));
```

**æ–¹æ³•allMatch**/**noneMatch**ï¼šæ£€æŸ¥æ˜¯å¦æ‰€æœ‰å…ƒç´ /æ²¡æœ‰å…ƒç´ æ»¡è¶³è°“è¯ã€‚

## 7. Optional

Java 8ä¸­å¼•å…¥äº†Optionalç±»ï¼Œç”¨äºè¡¨ç¤ºä¸€ä¸ªå€¼å¯èƒ½å­˜åœ¨ã€ä¹Ÿå¯èƒ½ä¸å­˜åœ¨çš„æƒ…å†µã€‚å®ƒæ˜¯ä¸€ä¸ªå®¹å™¨å¯¹è±¡ï¼Œå¯ä»¥åŒ…å«ä¸€ä¸ªéç©ºçš„å€¼æˆ–è€…ç©ºå€¼ã€‚ä¸å€¼å¼•ç”¨ç›¸æ¯”ï¼ŒOptionalå¯¹è±¡å¯ä»¥æ›´åŠ ä¼˜é›…åœ°å¤„ç†å¯èƒ½å­˜åœ¨ç©ºå€¼çš„æƒ…å†µã€‚

### 1) è·å–Optionalå¯¹è±¡

æœ‰æ•ˆåœ°ä½¿ç”¨Optionalçš„å…³é”®æ˜¯è¦ä½¿ç”¨ä¸€ç§æ­£ç¡®çš„æ–¹æ³•ï¼Œå®ƒåœ¨å€¼å­˜åœ¨æ—¶ä½¿ç”¨è¯¥å€¼ï¼Œè€Œåœ¨å€¼ä¸å­˜åœ¨æ—¶äº§ç”Ÿä¸€ä¸ªæ›¿ä»£ç‰©ã€‚

**æ–¹æ³•Optional.of**ï¼šåˆ›å»ºä¸€ä¸ªåŒ…å«éç©ºå€¼çš„Optionalå¯¹è±¡ã€‚

```java
/*Optional.ofçš„ä½¿ç”¨*/
String str = "Java";
Optional<String> optional = Optional.of(str);
```

å€¼ä¸ºç©ºæ—¶ï¼Œè°ƒç”¨`Optional.of`å°†æŠ›å‡ºNullPointerExceptionã€‚

**æ–¹æ³•Optional.ofNullable**ï¼šæ ¹æ®å€¼æ˜¯å¦ä¸ºç©ºï¼Œåˆ›å»ºä¸€ä¸ªåŒ…å«å€¼æˆ–ç©ºå€¼çš„Optionalå¯¹è±¡ã€‚è°ƒç”¨`Optional.ofNullable(obj)`å°†åœ¨`obj`énullæ—¶è¿”å›`Optional.of(obj)`ï¼Œå¦åˆ™è¿”å›`Optional.empty()`ã€‚

åœ¨å€¼ä¸ºç©ºæ—¶ï¼Œé€šå¸¸ä»¥é»˜è®¤å€¼ä»£æ›¿ï¼š

- **æ–¹æ³•orElse**ï¼šæŒ‡å®šOptionalå¯¹è±¡å€¼ä¸ºç©ºæ—¶çš„é»˜è®¤å€¼ã€‚

```java
/*orElseçš„ä½¿ç”¨*/
String result = optional.orElse("");
```

- **æ–¹æ³•orElseGet**ï¼šæ¥æ”¶ä¸€ä¸ªSupplierå¯¹è±¡ï¼ˆè§\[4 2. 3) å‡½æ•°å¼æ¥å£ï¼‰ï¼Œåœ¨Optionalå¯¹è±¡å€¼ä¸ºç©ºæ—¶è¿”å›è¯¥Supplierå¯¹è±¡çš„è¿”å›å€¼ã€‚

```java
/*orElseGetçš„ä½¿ç”¨*/
String result = optional.orElseGet(
	() -> System.getProperty("myapp.default"));
```

- **æ–¹æ³•orElseThrow**ï¼šåœ¨Optionalå¯¹è±¡å€¼ä¸ºç©ºæ—¶æŠ›å‡ºå¼‚å¸¸ã€‚

```java
/*orElseThrowçš„ä½¿ç”¨*/
String result = optional.orElseThrow(IllegalStateException::new);
```

### 2) ä½¿ç”¨Optionalå¯¹è±¡

**æ–¹æ³•ifPresent**ï¼šæ¥æ”¶ä¸€ä¸ªæ–¹æ³•ï¼Œå¦‚æœOptionalå¯¹è±¡å€¼éç©ºï¼Œå°†å…¶ä¼ é€’ç»™è¯¥æ–¹æ³•ï¼Œå¦åˆ™ä»€ä¹ˆéƒ½ä¸åšã€‚

ä¾‹å¦‚ï¼Œåœ¨è¯¥å€¼å­˜åœ¨æ—¶å°†å…¶æ·»åŠ åˆ°ç»“æœé›†åˆä¸­ï¼š

```java
/*ifPresentçš„ä½¿ç”¨*/
optional.ifPresent(v -> results.add(v));
//æˆ–è€…
optional.ifPresent(results::add);
```

**æ–¹æ³•ifPresentOrElse**ï¼šæ¥æ”¶ä¸¤ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«åœ¨Optionalå¯¹è±¡å€¼éç©º/ä¸ºç©ºæ—¶è°ƒç”¨ã€‚

```java
/*ifPresentOrElseçš„ä½¿ç”¨*/
optional.ifPresentOrElse(
	v -> System.out.println("Found " + v),
	() -> logger.warning("No match"));
```

**æ–¹æ³•or**ï¼šå°†ç©ºOptionalæ›¿æ¢ä¸ºä¸€ä¸ªå¯æ›¿ä»£çš„Optionalï¼Œåè€…ä»¥æƒ°æ€§æ–¹å¼è®¡ç®—ã€‚

```java
/*orçš„ä½¿ç”¨*/
Optional<String> result = optional.or(
	() -> alternatives.stream()
					  .findFirst());
```

`optional`éç©ºæ—¶å°†å…¶èµ‹ç»™`result`ï¼Œå¦åˆ™èµ‹ä»¥lambdaçš„è®¡ç®—ç»“æœã€‚

### 3) â€œæµæ°´çº¿åŒ–â€å¤„ç†Optionalå¯¹è±¡

mapä¸filterä¹Ÿå¯ä»¥å¤„ç†Optionalå¯¹è±¡ã€‚ç±»ä¼¼äºæµæ“ä½œæ–¹æ³•çš„é“¾å¼è°ƒç”¨ï¼ŒOptionalå¯¹è±¡çš„æ“ä½œæ–¹æ³•ä¹Ÿå¯ä»¥â€œæµæ°´çº¿åŒ–â€ã€‚

```java
/*é“¾å¼è°ƒç”¨Optionalå¯¹è±¡çš„æ“ä½œæ–¹æ³•*/
Optional<String> transformed = optional.map(String::toUpperCase)
									   .filter(s -> s.contains("E"));
									   //optionalä¸æ»¡è¶³è°“è¯æ—¶transformedä¸ºç©º

transformed.map(results::add); //transformedéç©ºæ—¶æ·»åŠ åˆ°ç»“æœé›†åˆ
```

å‡è®¾æœ‰ä¸€ä¸ªè¿”å›Optional\<T>å¯¹è±¡çš„æ–¹æ³•fï¼Œä»¥åŠä¸€ä¸ªç›®æ ‡ç±»å‹ä¸ºTã€è¿”å›Optional\<U>å¯¹è±¡çš„æ–¹æ³•gï¼Œç»„åˆè°ƒç”¨`s.f().g()`æ— æ³•å·¥ä½œï¼Œå› ä¸º`s.f()`è¿”å›å€¼ç±»å‹ä¸ºOptiona\<T>è€ŒéTã€‚æ­¤æ—¶éœ€è°ƒç”¨flatMapã€‚

```java
Optional<U> result = s.f().flatMap(T::g);
```

### 4) ä¸é€‚åˆä½¿ç”¨Optionalå¯¹è±¡çš„æƒ…å†µ

**æ–¹æ³•get**ï¼šåœ¨Optionalå¯¹è±¡éç©ºæ—¶è·å¾—å…¶ä¸­åŒ…è£…çš„å…ƒç´ ï¼Œå¦åˆ™æŠ›å‡ºä¸€ä¸ªNoSuchElementExceptionã€‚

```java
//1
Optional<T> optional = ...;
optional.get()./*æŸç§æ–¹æ³•*/;

//2
T value = ...;
value./*æŸç§æ–¹æ³•*/;

//1å¹¶ä¸æ¯”2æ›´å®‰å…¨
```

**æ–¹æ³•isPresent/isEmpty**ï¼šæ£€æŸ¥æŸä¸ªOptionalå¯¹è±¡æ˜¯å¦ä¸ºç©ºã€‚

```java
//1
if (optional.isPresent()) optionalValue.get()./*æŸç§æ–¹æ³•*/;

//2
if (value != null) value./*æŸç§æ–¹æ³•*/;

//1å¹¶ä¸æ¯”2æ›´å®‰å…¨
```

æ­£ç¡®ä½¿ç”¨Optionalç±»å‹ï¼š

- Optionalç±»å‹å˜é‡æ°¸è¿œä¸åº”ä¸ºnullã€‚
- ä¸è¦ä½¿ç”¨Optionalç±»å‹çš„å­—æ®µã€‚åœ¨ç±»å†…ï¼Œåº”ä½¿ç”¨nullè¡¨ç¤ºç¼ºå¤±çš„å­—æ®µã€‚
- ä¸è¦ä½¿ç”¨Optionalç±»å‹çš„æ–¹æ³•å‚æ•°ï¼Œè€Œåº”ç¼–å†™åŒ…å«ä¸ä¸åŒ…å«è¯¥å‚æ•°çš„ä¸¤ä¸ªé‡è½½æ–¹æ³•ã€‚
- ä¸è¦åœ¨é›†åˆä¸­ä½¿ç”¨Optionalå¯¹è±¡ï¼Œå¹¶ä¸”ä¸è¦ç”¨ä½œMapçš„é”®ã€‚

### 5) å°†Optionalè½¬æ¢ä¸ºæµ

**æ–¹æ³•stream**ï¼šå°†ä¸€ä¸ªOptional\<T>å¯¹è±¡è½¬æ¢ä¸ºä¸€ä¸ªå…·æœ‰0ä¸ªæˆ–1ä¸ªå…ƒç´ çš„Stream\<T>å¯¹è±¡ã€‚

å‡å®šä¸€ä¸ªç”¨æˆ·IDæµä»¥åŠæ–¹æ³•lookupï¼š

```java
Optional<User>
lookup(String id)
```

è¦åœ¨è·å–ç”¨æˆ·æµæ—¶è·³è¿‡æ— æ•ˆIDï¼Œå¯ä»¥è¿‡æ»¤åå¯¹æœ‰æ•ˆIDè°ƒç”¨getï¼š

```java
Stream<String> ids = ...;
Stream<User> users = ids.map(Users::lookup)
						.filter(Optional::isPresent)
						.map(Optional::get);
```

è¿™æ ·ç”¨åˆ°äº†ä¸Šæ–‡ä¸­è­¦å‘Šè¿‡éœ€è¦æ…ç”¨çš„isPresentä¸getï¼Œä»¥ä¸‹è°ƒç”¨æ›´åŠ ä¼˜é›…ï¼š

```java
Stream<User> users = ids.map(Users::lookup)
						.flatMap(Optional::stream);
```

å‡å®šæ–¹æ³•Users.classicLookup(id)å°†è¿”å›ä¸€ä¸ªUserå¯¹è±¡æˆ–nullï¼Œå¯ä»¥è¿‡æ»¤æ‰nullï¼š

```java
Stream<User> users = ids.map(Users::classicLookup)
						.filter(Objects::nonNull);
```

ä¹Ÿå¯ä»¥è°ƒç”¨flatMapï¼š

```java
Stream<User> users = ids.flatMap(
	id -> Stream.ofNullable(Users.classicLookup(id)));
//æˆ–è€…
Stream<User> users = ids.map(Users::classicLookup)
	.flatMap(Stream::ofNullable);
```

## 8. æ”¶é›†ç»“æœ

å¯¹æµå¤„ç†å®Œæ¯•åï¼Œå¯ä»¥è°ƒç”¨æ–¹æ³•iteratoråˆ›å»ºç”¨ä»¥è®¿é—®å…ƒç´ çš„ç»å…¸è¿­ä»£å™¨ï¼Œä¹Ÿå¯ä»¥è°ƒç”¨æ–¹æ³•forEachå¯¹æ¯ä¸ªå…ƒç´ åº”ç”¨æŒ‡å®šå‡½æ•°ï¼š

```java
stream.forEach(System.out::println);
```

åœ¨å¹¶è¡Œæµä¸Šï¼ŒforEachå°†æŒ‰ä»»æ„é¡ºåºè®¿é—®å…ƒç´ ï¼Œå¦‚éœ€æŒ‰å…ƒç´ çš„åŸé¡ºåºå¤„ç†ï¼Œå¯ä»¥è°ƒç”¨**æ–¹æ³•forEachOrdered**ï¼Œä¸è¿‡åŒæ—¶ä¹Ÿå°†å¤±å»å¹¶è¡Œå¤„ç†çš„ä¼˜åŠ¿ã€‚

**æ–¹æ³•toList**/**toArray**/...ï¼šç”±æµå…ƒç´ ç”ŸæˆList/Array/...ã€‚

ç”±äºæ³›å‹æ•°ç»„æ— æ³•åœ¨è¿è¡Œæ—¶åˆ›å»ºï¼Œè°ƒç”¨`stream.toArray()`å°†è¿”å›ä¸€ä¸ªObject\[]æ•°ç»„ï¼Œå¯ä»¥å°†ç›®æ ‡ç±»å‹ä¼ é€’ç»™æ•°ç»„æ„é€ å™¨ï¼š

```java
String[] result = stream.toArray(String[]::new);
```

**æ–¹æ³•collect**ï¼šå°†æµå…ƒç´ æ”¶é›†åˆ°å¦ä¸€ä¸ªç›®æ ‡ä¸­ï¼Œå®ƒæ¥æ”¶ä¸€ä¸ªCollectoræ¥å£å¯¹è±¡ã€‚

æ”¶é›†å™¨(collector)ï¼šæ”¶é›†ä¼—å¤šå…ƒç´ å¹¶ç”Ÿæˆå•ä¸€ç»“æœçš„å¯¹è±¡ï¼ŒCollectorsç±»æä¾›äº†å¤§é‡ç”¨äºç”Ÿæˆå¸¸è§æ”¶é›†å™¨çš„å·¥å‚æ–¹æ³•ã€‚

åœ¨toList/toSetè¢«æ·»åŠ åˆ°Java 16ä¹‹å‰ï¼Œå¿…é¡»ä½¿ç”¨ç”±æ–¹æ³•Collectors.toList/toSetç”Ÿæˆçš„æ”¶é›†å™¨ï¼š

```java
List<String> result = stream.collect(Collectors.toList());

Set<String> result = stream.collect(Collectors.toSet());
```

å¦‚éœ€æ§åˆ¶è·å¾—çš„Setçš„ç§ç±»ï¼Œå¯ä»¥è°ƒç”¨æ–¹æ³•toCollectionå¹¶ä¼ é€’ä¸€ä¸ªç›®æ ‡ç±»å‹çš„æ„é€ å™¨æ–¹æ³•å¼•ç”¨ã€‚

```java
TreeSet<String> result = stream.collect(Collectors.toCollection(TreeSet::new));
```

**æ–¹æ³•joining**ï¼šå°†æ‰€æœ‰æµå…ƒç´ è¿æ¥ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²ã€‚

```java
/*joiningçš„ä½¿ç”¨*/
String result = stream.collect(Collectors.joining());

String result = stream.collect(Collectors.joining(", ")); //è®¾ç½®åˆ†éš”ç¬¦
```

å¦‚æœæµä¸­åŒ…å«éå­—ç¬¦ä¸²å…ƒç´ ï¼Œéœ€å…ˆè½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼š

```java
String result = stream.map(Object::toString)
					  .collect(Collectors.joining(", "));
```

**æ–¹æ³•summarizing(Int|Long|Double)**ï¼šå°†æµçš„ç»“æœçº¦ç®€ä¸ºæ€»å’Œã€è®¡æ•°ã€å¹³å‡å€¼ã€æœ€å¤§å€¼æˆ–æœ€å°å€¼ã€‚

```java
IntSummaryStatistics summary = stream.collect(
	Collectors.summarizingInt(String::length));
double averageWordLength = summary.getAverage();
double maxWordLength = summary.getMax();
```

æ–¹æ³•toMapæœ‰ä¸¤ä¸ªæ–¹æ³•å¼•å…ƒï¼Œç”¨ä»¥äº§ç”Ÿkeyä¸valueã€‚

```java
public record Person(int id, String name) {}
...
Map<Integer, String> idToName = people.collect(
	Collectors.toMap(Person::id, Person::name));
Map<Integer, Person> idToPerson = people.collect(
	Collectors.toMap(Person::id, Function.identity()));
```

å½“keyå†²çªæ—¶ï¼Œcollectorå°†æŠ›å‡ºä¸€ä¸ªIllegalStateExceptionï¼Œå¯ä»¥æä¾›ç¬¬ä¸‰ä¸ªæ–¹æ³•å¼•å…ƒä»¥è¦†ç›–ï¼Œå®ƒåº”è¯¥è¿”å›å·²æœ‰å€¼ã€æ–°å€¼æˆ–å®ƒä»¬çš„ç»„åˆã€‚

å¦‚éœ€æŒ‡å®šç±»å‹ä¸ºTreeMapï¼Œå¯ä»¥æä¾›ç¬¬å››ä¸ªæ„é€ å™¨æ–¹æ³•å¼•å…ƒã€‚

```java
Map<Integer, Person> idToPerson = people.collect(
	Collectors.toMap(
		Person::id,
		Function.identity(),
		(existingValue, newValue) -> { throw new IllegalStateException(); },
		TreeMap::new));
```

## 9. ç¾¤ç»„ä¸åˆ†åŒº

> P27-28

## 10. æ”¶é›†å™¨æ–¹æ³•

**æ–¹æ³•groupingBy**ï¼šç”¨äºæ ¹æ®ç»™å®šçš„æ¡ä»¶å¯¹æµä¸­çš„å…ƒç´ è¿›è¡Œåˆ†ç»„æ“ä½œï¼Œæ¥æ”¶ä¸€ä¸ªæ–¹æ³•å‚æ•°ä½œä¸ºåˆ†ç»„ä¾æ®ï¼Œè¿”å›ä¸€ä¸ªCollectorå¯¹è±¡ï¼Œåè€…å¯ä»¥ç”¨äºStream.collectã€‚

```java
/*groupingByçš„ä½¿ç”¨*/
List<String> words
	= Arrays.asList("apple", "banana", "cat", "dog", "elephant");
Map<Integer, List<String>> groups
	= words.stream()
		   .collect(Collectors.groupingBy(String::length));
System.out.println(groups);
```

```text
/*æ§åˆ¶å°è¾“å‡º*/
{3=[cat, dog], 5=[apple], 6=[banana], 8=[elephant]}
```

Javaæä¾›äº†å¤šç§å¯ä»¥å°†æ”¶é›†åˆ°çš„å…ƒç´ çº¦ç®€ä¸ºæ•°å­—çš„æ”¶é›†å™¨æ–¹æ³•ï¼š

- **æ–¹æ³•counting**ï¼šè¿”å›æ”¶é›†åˆ°çš„å…ƒç´ çš„ä¸ªæ•°ã€‚
- **æ–¹æ³•summing(Int|Long|Double)**/**averaging(Int|Long|Double)**ï¼šæ¥æ”¶ä¸€ä¸ªæ–¹æ³•å¼•å…ƒï¼Œå¯¹ä¸‹æ¸¸å…ƒç´ è°ƒç”¨ï¼Œè¿”å›å…¶å’Œ/å¹³å‡å€¼ã€‚
- **æ–¹æ³•maxBy**/**minBy**ï¼šæ¥æ”¶ä¸€ä¸ªcomparatorï¼Œè¿”å›ä¸‹æ¸¸å…ƒç´ ä¸­çš„æœ€å¤§å€¼/æœ€å°å€¼ã€‚

**æ–¹æ³•collectingAndThen**ï¼šåœ¨æ”¶é›†å™¨åæ·»åŠ ä¸€ä¸ªæœ€ç»ˆå¤„ç†æ“ä½œã€‚

ä¾‹å¦‚ï¼Œå¦‚éœ€è·å–äº’å¼‚çš„ç»“æœæ€»æ•°ï¼Œå¯ä»¥å°†å…¶æ”¶é›†åˆ°Setä¸­ï¼Œç„¶åå¯¹åè€…è°ƒç”¨sizeï¼š

```java
/*collectingAndThençš„ä½¿ç”¨*/
Map<Character, Integer> stringCountsByStartingLetter = strings.collect(
	groupingBy(s -> s.charAt(0),
		collectingAndThen(toSet(), Set::size)));
```

**æ–¹æ³•mapping**ï¼šå¯¹æ”¶é›†åˆ°çš„å…ƒç´ è°ƒç”¨æŒ‡å®šæ–¹æ³•ï¼Œå¹¶å°†ç»“æœä¼ é€’ç»™å…¶ä¸‹æ¸¸æ”¶é›†å™¨ã€‚

ä¾‹å¦‚ï¼Œå¯¹å­—ç¬¦ä¸²æŒ‰é¦–å­—æ¯åˆ†ç»„ï¼Œåœ¨æ¯ç»„å†…éƒ¨è®¡ç®—å­—ç¬¦ä¸²é•¿åº¦ï¼Œå¹¶å°†è¿™äº›é•¿åº¦æ”¶é›†åˆ°Setä¸­ï¼š

```java
/*mappingçš„ä½¿ç”¨*/
Map<Character, Set<Integer>> stringLengthsByStartingLetter = strings.collect(
	groupingBy(s -> s.charAt(0),
		mapping(String::length, toSet())));
```

**æ–¹æ³•filtering**ï¼šå°†ä¸€ä¸ªfilteråº”ç”¨åˆ°æ¯ä¸ªç»„ä¸Šã€‚

```java
Map<String, Set<City>> largeCitiesByState = cities.collect(
	groupingBy(City::state,
		filtering(c -> c.population() > 50,0000,
			toSet())));
```

**æ–¹æ³•teeing**ï¼šå°†ä¸¤ä¸ªæ”¶é›†å™¨çš„ç»“æœåˆå¹¶ä¸ºä¸€ä¸ªã€‚

ä¾‹å¦‚ï¼Œéœ€è¦æ”¶é›†åŸå¸‚åå¹¶è®¡ç®—å¹³å‡äººå£ï¼Œå¯ä»¥ç”¨teeingæ‰§è¡Œä¸¤æ¬¡è®¡ç®—ï¼Œç„¶åå°†ç»“æœç»„åˆï¼š

```java
/*teeingçš„ä½¿ç”¨*/
record Pair<S, T>(S first, T second) {}
Pair<List<String>, Double> result = cities.filter(c -> c.state().equals("NW"))
.collect(teeing(
	mapping(City::name, toList()), //ç¬¬ä¸€æ”¶é›†å™¨
	averagingDouble(City::population), //ç¬¬äºŒæ”¶é›†å™¨
	(list, avg) -> new Result(list, avg))); //ç»“æœç»„åˆæ–¹æ³•
```

æ”¶é›†å™¨çš„ç»„åˆä½¿ç”¨æ˜¯ä¸€ç§å¼ºå¤§çš„æ–¹å¼ï¼Œä½†ä¹Ÿå¯èƒ½å¯¼è‡´å¤æ‚çš„è¡¨è¾¾å¼ï¼Œæœ€ä½³ç”¨æ³•æ˜¯ä¸groupingByå’ŒpartitioningByä¸€èµ·å¤„ç†ä¸‹æ¸¸Mapä¸­çš„å€¼ï¼Œå¦åˆ™ï¼Œåº”ç›´æ¥å¯¹æµè°ƒç”¨mapã€reduceã€countã€maxä¸minç­‰æ–¹æ³•ã€‚

## 11. çº¦ç®€æ“ä½œ

**æ–¹æ³•reduce**ï¼šå°†æµä¸­çš„å…ƒç´ æŒ‰ç…§æŒ‡å®šçš„æ“ä½œè¿›è¡Œç´¯ç§¯ã€åˆå¹¶æˆ–æ±‚å€¼ï¼Œæ¥æ”¶ä¸€ä¸ªäºŒå…ƒæ“ä½œå‚æ•°ï¼Œå¹¶ä»å‰ä¸¤ä¸ªå…ƒç´ å¼€å§‹æŒç»­å¯¹æµå…ƒç´ æ“ä½œã€‚

ç»™å®šçº¦ç®€æ“ä½œ`op`ï¼Œçº¦ç®€å°†äº§ç”Ÿ`s_1 op s_2 op s_3 op ...`ï¼Œå…¶ä¸­`s_i op s_{i + 1}`è¡¨ç¤ºæ–¹æ³•è°ƒç”¨`op(s_i, s_{i + 1})`ã€‚

ä¾‹å¦‚ï¼Œå¯¹æ‰€æœ‰æµå…ƒç´ æ±‚å’Œï¼š

```java
/*reduceçš„ä½¿ç”¨*/
List<Integer> values = ...;
Optional<Integer> sum = values.stream()
							  .reduce((x, y) -> x + y);
```

æ­¤å¤„çš„lambdaå¯ä»¥æ”¹å†™ä¸ºæ–¹æ³•å¼•ç”¨`.reduce(Integer::sum)`ã€‚å½“`values`ä¸ºç©ºæ—¶ï¼Œreduceå°†è¿”å›ä¸€ä¸ªOptionalå¯¹è±¡ã€‚

çº¦ç®€çš„å®é™…åº”ç”¨æœ‰æ±‚å’Œã€ä¹˜ç§¯ã€å­—ç¬¦ä¸²è¿æ¥ã€æ±‚æœ€å€¼ã€æ±‚å¹¶é›†/äº¤é›†ç­‰ã€‚

å¯¹å¹¶è¡Œæµçº¦ç®€æ—¶ï¼Œçº¦ç®€æ“ä½œå¿…é¡»æ»¡è¶³ç»“åˆå¾‹ï¼Œå³`(x op y) op z`éœ€ç­‰äº`x op (y op z)`ï¼Œä»¥ä¿è¯ç»“æœä¸å…ƒç´ é¡ºåºæ— å…³ã€‚

å¹ºå…ƒå€¼ï¼šæ»¡è¶³`e op x = x`çš„å€¼`e`ï¼Œé€šå¸¸ä½œä¸ºè®¡ç®—èµ·ç‚¹ï¼Œä¾‹å¦‚ï¼Œ0ä¸ºåŠ æ³•çš„å¹ºå…ƒå€¼ã€‚

```java
/*å¹ºå…ƒå€¼çš„ä½¿ç”¨*/
Integer sum = values.stream()
					.reduce(0, (x, y) -> x + y);
```

ä¸ä¸Šæ–‡ä¸åŒï¼Œç”±äºæ­¤å¤„ä½¿ç”¨äº†å¹ºå…ƒå€¼0ï¼Œå½“`values`ä¸ºç©ºæ—¶ï¼Œreduceå°†è¿”å›å°è£…äº†0çš„åŒ…è£…å™¨ç±»å¯¹è±¡ï¼Œè€Œä¸æ˜¯Optionalå¯¹è±¡ã€‚

## 12. åŸºæœ¬ç±»å‹æµ

> æ¦‚å¿µè§\[11 3. mapä¸flatMap]

æ–¹æ³•IntStream.of/Arrays.streamï¼šåˆ›å»ºIntStreamã€‚

```java
IntStream stream = IntStream.of(1, 1, 2, 3, 5);
//æˆ–è€…
int[] values = {1, 1, 2, 3, 5};
IntStream stream = Arrays.stream(values, 0, 4);
```

å¯¹è±¡ç±»å‹æµçš„æ–¹æ³•generateä¸iterateåŒæ ·é€‚ç”¨äºåŸºæœ¬ç±»å‹æµã€‚

é™æ€æ–¹æ³•range/rangeClosedï¼šç”Ÿæˆæ­¥é•¿ä¸º1çš„æ•´æ•°åŒºé—´ã€‚

```java
/*range/rangeClosedçš„ä½¿ç”¨*/
IntStream zeroToNinetyNine = IntStream.range(0, 100);
IntStream zeroToOneHundred = IntStream.rangeClosed(0, 100);
```

## 13. å¹¶è¡Œæµ

æ–¹æ³•parallelStreamï¼šç”Ÿæˆå¹¶è¡Œæµã€‚

```java
/*parallelStreamçš„ä½¿ç”¨*/
List<String> words = ...;
Stream<String> parallesWords = words.parallelStream();
```

æ–¹æ³•parallelï¼šç”±å·²æœ‰æµç”Ÿæˆå¹¶è¡Œæµã€‚

```java
/*parallelçš„ä½¿ç”¨*/
Stream<String> words = ...;
Stream<String> parallelWords = words.parallel();
```

æ‰§è¡Œç»ˆæ­¢æ“ä½œæ—¶ï¼Œå¦‚æœæµå¤„äºå¹¶è¡Œæ¨¡å¼ï¼Œæ‰€æœ‰ä¸­é—´æ“ä½œéƒ½å°†å¹¶è¡ŒåŒ–ã€‚

ä½¿ç”¨å¹¶è¡Œæµçš„åŸåˆ™ä¸ºå…¶è¿”å›ç»“æœå¿…é¡»ä¸é¡ºåºæ“ä½œçš„è¿”å›ç»“æœä¸€è‡´ï¼Œè¿™è¦æ±‚æ— çŠ¶æ€çš„ã€å¯ä»¥ä»¥ä»»æ„é¡ºåºæ‰§è¡Œçš„æ“ä½œã€‚

ä¾‹å¦‚ï¼Œå¯¹å­—ç¬¦ä¸²æµä¸­çš„çŸ­å•è¯è®¡æ•°ï¼š

```java
var shortWords = new int[12];
words.parallelStream().forEach(
	s -> { if (s.length() < 12) shortWords[s.length()]++; });
System.out.println(Arrays.toString(shortWords));
```

è¿™æ®µä»£ç éå¸¸ç³Ÿç³•ï¼Œä¼ é€’ç»™forEachçš„lambdaå°†åœ¨å¤šä¸ªå¹¶å‘çº¿ç¨‹ä¸­è¿è¡Œï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½å°†æ›´æ–°åŒä¸€ä¸ªæ•°ç»„`shortWords`ï¼Œé€ æˆæ··ä¹±çš„ç«äº‰ã€‚

è¦å®‰å…¨åœ°å¹¶è¡ŒåŒ–æ­¤æ“ä½œï¼Œå¯ä»¥ä»¥é•¿åº¦å¯¹å­—ç¬¦ä¸²åˆ†ç»„ï¼Œç„¶ååˆ†åˆ«è®¡æ•°ï¼š

```java
Map<Integer, Long> shortWordCounts
	= words.parallelStream()
		   .filter(s -> s.length() < 12)
		   .collect(groupingBy(
			   String::length,
			   counting()));
```