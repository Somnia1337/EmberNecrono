@2024.06.06 | Week 15

卢剑歌 2022141461145

### 1. 验证 PE/COFF 格式

结构 `SECTION HEADER #1`：

```text
.drectve name
       0 physical address
       0 virtual address
      26 size of raw data
      B4 file pointer to raw data
       0 file pointer to relocation table
       0 file pointer to line numbers
       0 number of relocations
       0 number of line numbers
  100A00 flags
         Info
         Remove
         1 byte align
```

结构 `RAW DATA #1`：

```text
  00000000: 2D 64 65 66 61 75 6C 74 6C 69 62 3A 4C 49 42 43  -defaultlib:LIBC
  00000010: 20 2D 64 65 66 61 75 6C 74 6C 69 62 3A 4F 4C 44   -defaultlib:OLD
  00000020: 4E 41 4D 45 53 20                                NAMES 

   Linker Directives
   -----------------
   -defaultlib:LIBC
   -defaultlib:OLDNAMES
```

结构 `SECTION HEADER #2`：

```text
   .data name
       0 physical address
       0 virtual address
       C size of raw data
      DA file pointer to raw data
       0 file pointer to relocation table
       0 file pointer to line numbers
       0 number of relocations
       0 number of line numbers
C0300040 flags
         Initialized Data
         4 byte align
         Read Write
```

结构 `RAW DATA #2`：

```text
  00000000: 54 00 00 00 55 00 00 00 25 64 0A 00              T...U...%d..
```

结构 `SECTION HEADER #3`：

```text
   .text name
       0 physical address
       0 virtual address
      44 size of raw data
      E6 file pointer to raw data
     12A file pointer to relocation table
       0 file pointer to line numbers
       5 number of relocations
       0 number of line numbers
60500020 flags
         Code
         16 byte align
         Execute Read
```

结构 `RAW DATA #3`：

```text
  00000000: 55 8B EC 8B 45 08 50 68 00 00 00 00 E8 00 00 00  U...E.Ph........
  00000010: 00 83 C4 08 5D C3 55 8B EC 83 EC 08 C7 45 FC 01  ....].U......E..
  00000020: 00 00 00 A1 00 00 00 00 03 05 00 00 00 00 03 45  ...............E
  00000030: FC 03 45 F8 50 E8 00 00 00 00 83 C4 04 8B 45 FC  ..E.P.........E.
  00000040: 8B E5 5D C3                                      ..].
```

结构 `RELOCATIONS #3`：

```text
 Symbol    Symbol
 Offset    Type              Applied To         Index     Name
 --------  ----------------  -----------------  --------  ------
 00000008  DIR32                      00000000         E  $SG39
 0000000D  REL32                      00000000         D  _printf
 00000024  DIR32                      00000000         7  _?static_var@?1??main@@9@9
 0000002A  DIR32                      00000000        12  _?static_var2@?1??main@@9@9
 00000036  REL32                      00000000         C  _func1
```

结构 `SECTION HEADER #4`：

```text
    .bss name
       0 physical address
       0 virtual address
       4 size of raw data
       0 file pointer to raw data
       0 file pointer to relocation table
       0 file pointer to line numbers
       0 number of relocations
       0 number of line numbers
C0300080 flags
         Uninitialized Data
         4 byte align
         Read Write
```

> [!question] `.obj` 和 `.exe` 是否一样大？为什么？

不一样。因为 `.exe` 还需要经过链接其他库文件形成。

> [!question] `.obj` 中的虚拟地址都为 `0`，而 `.exe` 中不为 `0`，说明了什么？

说明经过链接确定了函数等的实际地址。

### 2. 静态链接原理

- `a.obj`
	- `drectve`：26
	- `text`：20
- `b.obj`
	- `drectve`：26
	- `data`：4
	- `text`：32
- `ab.exe`
	- `text`：4000
	- `rdata`：1000
	- `data`：3000

> [!question] `size(a.obj.text) + size(b.obj.text) != size(ab.exe.text)`，为什么？

可能的原因有：

- 对齐
- 优化
- 引入库

### 3. 观察重定位表

```text
 Offset    Type              Applied To         Index     Name
 --------  ----------------  -----------------  --------  ------
 00000006  DIR32                      00000000         9  _bufp1
 0000000A  DIR32                      00000004         8  _buf
 0000000F  DIR32                      00000000         7  _bufp0
 0000001A  DIR32                      00000000         7  _bufp0
 0000001F  DIR32                      00000000         9  _bufp1
 00000029  DIR32                      00000000         9  _bufp1
```

> [!question] 为什么重定位表中这些符号顺序是这样的？

`main.obj`：

```asmatmel
00000000: 55                 push        ebp
00000001: 8B EC              mov         ebp,esp
00000003: E8 00 00 00 00     call        00000008
00000008: 33 C0              xor         eax,eax
0000000A: 5D                 pop         ebp
0000000B: C3                 ret
```

`swap.obj`：

```asmatmel
00000000: 55                 push        ebp
00000001: 8B EC              mov         ebp,esp
00000003: 51                 push        ecx
00000004: C7 05 00 00 00 00  mov         dword ptr [_swap],4
		04 00 00 00
0000000E: A1 00 00 00 00     mov         eax,[_swap]
00000013: 8B 08              mov         ecx,dword ptr [eax]
00000015: 89 4D FC           mov         dword ptr [ebp-4],ecx
00000018: 8B 15 00 00 00 00  mov         edx,dword ptr [_swap]
0000001E: A1 00 00 00 00     mov         eax,[_swap]
00000023: 8B 08              mov         ecx,dword ptr [eax]
00000025: 89 0A              mov         dword ptr [edx],ecx
00000027: 8B 15 00 00 00 00  mov         edx,dword ptr [_swap]
0000002D: 8B 45 FC           mov         eax,dword ptr [ebp-4]
00000030: 89 02              mov         dword ptr [edx],eax
00000032: 8B E5              mov         esp,ebp
00000034: 5D                 pop         ebp
00000035: C3                 ret
```